<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bazar Pro | God Mode</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Manrope:wght@400;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --accent: #00ffaa; --bg: #030303; --card: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08); --neon-shadow: 0 0 15px rgba(0, 255, 170, 0.3); }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); color: #fff; overflow-x: hidden; background-image: radial-gradient(circle at 50% -20%, #00ffaa15, transparent); }
        .font-brand { font-family: 'Unbounded', sans-serif; }
        .glass { background: var(--card); backdrop-filter: blur(25px); border: 1px solid var(--border); }
        
        /* ‚ú® –ú–∏–∫—Ä–æ–≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è */
        .btn-prime { background: linear-gradient(135deg, var(--accent), #00d4ff); color: #000; font-weight: 800; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); border-radius: 1.2rem; }
        .btn-prime:active { transform: scale(0.92); }
        .hover-scale { transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .hover-scale:hover { transform: translateY(-5px) scale(1.02); }

        /* üì± Mobile UI Fixes */
        .tab-bar-item { opacity: 0.4; transition: 0.4s; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .tab-bar-item.active { opacity: 1; color: var(--accent); filter: drop-shadow(0 0 8px var(--accent)); }
        
        /* üíé –°—Ç–∞—Ç—É—Å—ã –∏ –ë–µ–π–¥–∂–∏ */
        .badge { font-size: 7px; font-weight: 900; padding: 3px 8px; border-radius: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-top { background: #ff3366; color: #fff; box-shadow: 0 0 10px rgba(255, 51, 102, 0.5); }
        .badge-new { background: var(--accent); color: #000; }
        .badge-urgent { background: #ffcc00; color: #000; }

        /* üìä –ü—É–ª—å—Å–∞—Ü–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ */
        .stat-pulse { animation: pulse-dot 2s infinite; }
        @keyframes pulse-dot { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* üì¢ –ë–∞–Ω–Ω–µ—Ä */
        .announcement-bg { background: linear-gradient(90deg, #00ffaa33, transparent, #00ffaa33); border-bottom: 1px solid var(--accent); }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="pb-32">

<div id="app" v-cloak>
    
    <!-- 1. AGE GATE (18+) -->
    <div v-if="!ageVerified" class="fixed inset-0 z-[5000] bg-[#030303] flex items-center justify-center p-8 text-center">
        <div class="animate__animated animate__fadeInUp">
            <div class="w-20 h-20 bg-[#00ffaa] rounded-[2rem] mx-auto mb-8 flex items-center justify-center text-black text-4xl font-black shadow-[0_0_50px_rgba(0,255,170,0.5)]">B</div>
            <h1 class="font-brand text-2xl mb-2 italic uppercase">Bazar Pro</h1>
            <p class="text-gray-500 text-[10px] mb-12 tracking-[0.3em] uppercase">–ö–æ–Ω—Ç–µ–Ω—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –≤–∑—Ä–æ—Å–ª—ã—Ö</p>
            <button @click="verifyAge" class="btn-prime w-full py-6 px-12 uppercase text-[10px] tracking-widest">–ú–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç</button>
        </div>
    </div>

    <div v-else>
        
        <!-- üì¢ –ì–õ–û–ë–ê–õ–¨–ù–û–ï –û–ë–™–Ø–í–õ–ï–ù–ò–ï -->
        <div v-if="settings.announcement" class="announcement-bg py-2 px-6 overflow-hidden relative">
            <div class="whitespace-nowrap animate-[marquee_20s_linear_infinite] text-[9px] font-black uppercase tracking-widest text-[#00ffaa]">
                {{ settings.announcement }} ‚Ä¢ {{ settings.announcement }} ‚Ä¢ {{ settings.announcement }}
            </div>
        </div>

        <!-- üìä –®–ê–ü–ö–ê + –î–ê–®–ë–û–†–î –°–¢–ê–¢–ò–°–¢–ò–ö–ò -->
        <header class="p-6 pb-2">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 @click="view = 'home'" class="font-brand text-2xl font-black italic tracking-tighter cursor-pointer">BAZAR<span class="text-[#00ffaa]">.</span></h1>
                    <div class="flex items-center gap-3 mt-1">
                        <div class="flex items-center gap-1.5 glass px-2 py-0.5 rounded-full">
                            <span class="w-1 h-1 bg-[#00ffaa] rounded-full stat-pulse"></span>
                            <span class="text-[8px] font-bold uppercase opacity-60">{{ items.length }} –ª–æ—Ç–æ–≤</span>
                        </div>
                        <div class="flex items-center gap-1.5 glass px-2 py-0.5 rounded-full border-white/5">
                            <span class="text-[8px] font-bold uppercase opacity-60">{{ marketVolume.toLocaleString() }} ‚ÇΩ –æ–±–æ—Ä–æ—Ç–∞</span>
                        </div>
                    </div>
                </div>
                <div v-if="user" @click="view = 'profile'" class="relative group">
                    <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" 
                         class="w-12 h-12 rounded-2xl glass p-0.5 object-cover ring-2 ring-white/5 group-hover:ring-[#00ffaa]/50 transition-all">
                </div>
                <button v-else @click="view = 'auth'" class="btn-prime px-6 py-2 text-[10px] uppercase">–í—Ö–æ–¥</button>
            </div>

            <!-- üî• –°–ï–ö–¶–ò–Ø ¬´–ì–û–†–Ø–ß–ï–ï¬ª (SLIDER) -->
            <div v-if="view === 'home' && hotItems.length" class="mb-10">
                <div class="flex items-center justify-between mb-4 px-1">
                    <h3 class="text-[10px] font-black uppercase tracking-widest text-[#00ffaa]">–ì–æ—Ä—è—á–∏–µ –Ω–æ–≤–∏–Ω–∫–∏ üî•</h3>
                    <span class="text-[8px] opacity-30 uppercase font-bold">–õ–∏—Å—Ç–∞–π –≤–ø—Ä–∞–≤–æ</span>
                </div>
                <div class="flex gap-4 overflow-x-auto no-scrollbar -mx-2 px-2">
                    <div v-for="item in hotItems" :key="item.id" @click="openItem(item)" 
                         class="min-w-[280px] h-44 glass rounded-[2.5rem] relative overflow-hidden flex-shrink-0 p-6 flex flex-col justify-end group active:scale-95 transition-all">
                        <img :src="item.img" class="absolute inset-0 w-full h-full object-cover opacity-40 group-hover:scale-110 transition-transform duration-700">
                        <div class="absolute inset-0 bg-gradient-to-t from-black to-transparent"></div>
                        <div class="relative z-10">
                            <div class="flex gap-2 mb-2">
                                <span class="badge badge-top">Exclusive</span>
                                <span class="badge badge-new">New</span>
                            </div>
                            <h4 class="font-brand text-sm uppercase truncate">{{item.title}}</h4>
                            <p class="text-[#00ffaa] font-black text-lg">{{item.price.toLocaleString()}} ‚ÇΩ</p>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <main class="px-6 pb-40">
            <transition name="animate__animated" enter-active-class="animate__fadeInUp animate__faster" mode="out-in">

                <!-- –í–ò–¢–†–ò–ù–ê -->
                <div v-if="view === 'home'" key="home">
                    <div class="mb-8 space-y-4">
                        <div class="glass rounded-[1.8rem] flex items-center px-4 py-1 group focus-within:border-[#00ffaa]/50 transition-all">
                            <span class="opacity-20 ml-2 group-focus-within:opacity-100 transition-opacity">üîç</span>
                            <input v-model="searchQuery" type="text" placeholder="–ü–æ–∏—Å–∫ –¥–µ–≤–∞–π—Å–∞ –∏–ª–∏ –≥–æ—Ä–æ–¥–∞..." class="bg-transparent border-none w-full p-4 text-sm focus:ring-0 text-white placeholder:text-white/20">
                        </div>
                        <div class="flex gap-2 overflow-x-auto no-scrollbar">
                            <div v-for="c in categories" :key="c" @click="filters.cat = c" 
                                :class="['px-6 py-3 rounded-full text-[10px] font-black uppercase glass whitespace-nowrap transition-all hover:border-[#00ffaa]/30', {active: filters.cat === c}]">
                                {{c}}
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div v-for="item in sortedItems" :key="item.id" @click="openItem(item)" class="glass rounded-[2.5rem] p-3 relative hover-scale group">
                            <div class="aspect-square rounded-[1.8rem] overflow-hidden mb-3 bg-black/40 relative">
                                <img :src="item.img" class="w-full h-full object-cover">
                                
                                <!-- ‚ù§Ô∏è –ö–Ω–æ–ø–∫–∞ –ò–∑–±—Ä–∞–Ω–Ω–æ–≥–æ -->
                                <button @click.stop="toggleFavorite(item.id)" class="absolute top-3 right-3 w-8 h-8 rounded-xl glass flex items-center justify-center text-[10px] z-20 hover:scale-110 transition-all">
                                    {{ isFavorite(item.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                                </button>

                                <!-- üõ°Ô∏è –ë–µ–π–¥–∂–∏ –°—Ç–∞—Ç—É—Å–∞ -->
                                <div class="absolute top-3 left-3 flex flex-col gap-1">
                                    <span v-if="item.price > 5000" class="badge badge-top w-fit">Top</span>
                                    <span v-if="item.id % 3 === 0" class="badge badge-urgent w-fit">üî• –°—Ä–æ—á–Ω–æ</span>
                                    <span v-if="userMap[item.user_id]?.is_verified" class="badge badge-new w-fit flex items-center gap-1">üõ°Ô∏è Verified</span>
                                </div>

                                <div v-if="item.status === 'sold'" class="absolute inset-0 bg-black/70 backdrop-blur-[2px] flex items-center justify-center">
                                    <span class="border-2 border-red-500 text-red-500 px-3 py-1 rounded-xl text-[10px] font-black -rotate-12 uppercase">Sold Out</span>
                                </div>
                            </div>
                            <div class="px-2">
                                <h3 class="text-[11px] font-black uppercase truncate mb-1">{{item.title}}</h3>
                                <div class="flex justify-between items-center">
                                    <span class="text-[#00ffaa] font-brand text-[12px] font-black">{{item.price.toLocaleString()}} ‚ÇΩ</span>
                                    <span class="text-[8px] opacity-30 font-bold uppercase truncate max-w-[50px]">{{item.city}}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü–†–û–§–ò–õ–¨ 2.0 (–° –ò–ó–ë–†–ê–ù–ù–´–ú) -->
                <div v-else-if="view === 'profile' && user" key="profile" class="max-w-4xl mx-auto space-y-6">
                    <div class="glass rounded-[3rem] p-8 text-center relative overflow-hidden">
                        <div v-if="isAdmin" @click="view = 'admin'" class="absolute top-6 right-6 p-3 glass rounded-2xl cursor-pointer hover:bg-[#ff3366] transition-all">üõ†Ô∏è</div>
                        <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-24 h-24 rounded-[2.5rem] mx-auto mb-6 object-cover ring-4 ring-[#00ffaa]/20">
                        <h2 class="font-brand text-2xl uppercase italic leading-none">{{user.name}} <span v-if="user.has_crown">üëë</span></h2>
                        <p class="text-[10px] opacity-40 uppercase font-black mt-3 tracking-[0.2em]">{{ user.bio || '–õ–µ–≥–µ–Ω–¥–∞ Bazar Pro' }}</p>
                    </div>

                    <!-- –í–∫–ª–∞–¥–∫–∏ –ö–∞–±–∏–Ω–µ—Ç–∞ -->
                    <div class="flex gap-2 overflow-x-auto no-scrollbar">
                        <button @click="profileTab = 'my'" :class="['px-6 py-4 rounded-2xl text-[10px] font-black uppercase glass flex items-center gap-2', {active: profileTab === 'my'}]">üì¶ –ú–æ–∏ –ª–æ—Ç—ã</button>
                        <button @click="profileTab = 'fav'" :class="['px-6 py-4 rounded-2xl text-[10px] font-black uppercase glass flex items-center gap-2', {active: profileTab === 'fav'}]">‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                        <button @click="profileTab = 'edit'" :class="['px-6 py-4 rounded-2xl text-[10px] font-black uppercase glass flex items-center gap-2', {active: profileTab === 'edit'}]">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>

                    <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ö–∞–±–∏–Ω–µ—Ç–∞ -->
                    <div v-if="profileTab === 'my'" class="space-y-4 animate__animated animate__fadeIn">
                        <div v-for="item in myItems" :key="item.id" class="glass p-5 rounded-[2.5rem] flex items-center justify-between group">
                            <div class="flex items-center gap-5">
                                <img :src="item.img" class="w-16 h-16 rounded-2xl object-cover">
                                <div>
                                    <div class="text-[11px] font-black uppercase mb-1">{{item.title}}</div>
                                    <div class="text-[#00ffaa] font-brand text-[10px]">{{item.price}} ‚ÇΩ</div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="toggleSold(item)" :class="['p-3 rounded-xl glass text-[9px] font-black', item.status === 'sold' ? 'text-green-500' : 'opacity-20']">‚úì</button>
                                <button @click="deleteItem(item.id)" class="p-3 glass rounded-xl text-red-500 text-xs">‚úï</button>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="profileTab === 'fav'" class="grid grid-cols-2 gap-4 animate__animated animate__fadeIn">
                        <div v-for="item in favoriteItems" :key="item.id" @click="openItem(item)" class="glass p-3 rounded-[2.5rem]">
                            <img :src="item.img" class="w-full aspect-square rounded-[1.8rem] object-cover mb-3">
                            <div class="text-[10px] font-black uppercase truncate mb-1">{{item.title}}</div>
                            <button @click.stop="toggleFavorite(item.id)" class="text-red-500 text-[8px] font-black uppercase">–£–±—Ä–∞—Ç—å ‚ù§Ô∏è</button>
                        </div>
                        <div v-if="favoriteItems.length === 0" class="col-span-2 py-10 text-center opacity-20 text-[10px] font-black uppercase">–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç</div>
                    </div>

                    <div v-else-if="profileTab === 'edit'" class="glass p-8 rounded-[3rem] space-y-6 animate__animated animate__fadeIn">
                        <div class="space-y-2">
                            <label class="text-[9px] font-black opacity-30 ml-4 uppercase">–ù–∏–∫–Ω–µ–π–º</label>
                            <input v-model="editUser.name" type="text" class="w-full p-5 glass rounded-2xl">
                        </div>
                        <div class="space-y-2">
                            <label class="text-[9px] font-black opacity-30 ml-4 uppercase">–ë–∏–æ / –û —Å–µ–±–µ</label>
                            <input v-model="editUser.bio" type="text" class="w-full p-5 glass rounded-2xl">
                        </div>
                        <button @click="saveProfile" class="btn-prime w-full py-6 text-[10px] font-black uppercase">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë</button>
                        <button @click="logout" class="w-full py-4 text-red-500 text-[9px] font-black uppercase opacity-40">–í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                    </div>
                </div>

                <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ, –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è, –ü—Ä–æ—Å–º–æ—Ç—Ä... -->
                <!-- –û–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏, –Ω–æ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏ –∫–Ω–æ–ø–æ–∫ -->

            </transition>
        </main>

        <!-- üïπÔ∏è –¢–ê–ö–¢–ò–õ–¨–ù–´–ô –¢–ê–ë-–ë–ê–† (MOBILE UX) -->
        <nav class="fixed bottom-8 inset-x-8 z-[100] max-w-sm mx-auto">
            <div class="glass rounded-[2.8rem] p-3 flex justify-around items-center shadow-[0_25px_60px_-15px_rgba(0,0,0,0.7)] backdrop-blur-3xl border-white/10">
                <button @click="view = 'home'" :class="['tab-bar-item p-3', {active: view === 'home'}]">
                    <span class="text-xl">üè†</span>
                    <span class="text-[8px] font-black uppercase tracking-widest">–í–∏—Ç—Ä–∏–Ω–∞</span>
                </button>
                <button @click="user ? view = 'add' : view = 'auth'" :class="['tab-bar-item p-3', {active: view === 'add'}]">
                    <div class="bg-[#00ffaa] text-black w-10 h-10 rounded-2xl flex items-center justify-center shadow-[0_0_20px_rgba(0,255,170,0.3)] hover:rotate-90 transition-all duration-500">
                        <span class="text-xl font-bold">+</span>
                    </div>
                    <span class="text-[8px] font-black uppercase tracking-widest">–ü—Ä–æ–¥–∞—Ç—å</span>
                </button>
                <button @click="user ? (view = 'profile' || view === 'admin') : view = 'auth'" :class="['tab-bar-item p-3', {active: view === 'profile' || view === 'admin'}]">
                    <span class="text-xl">üë§</span>
                    <span class="text-[8px] font-black uppercase tracking-widest">–ö–∞–±–∏–Ω–µ—Ç</span>
                </button>
            </div>
        </nav>
    </div>
</div>

<script>
const { createApp } = Vue;

const SUPABASE_URL = 'https://gcxnstwsqkmdotqblkfd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeG5zdHdzcWttZG90cWJsa2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDI3MzIsImV4cCI6MjA4MjM3ODczMn0.79gdNrKNRcdPTbban-6uK3GP5Czyq-II7kRHaRyfvqE';
const BOT_TOKEN = '7688454041:AAFFBc0Ye7RRq0RFuSst_QfTqQ0TpQu9aWI';
const MASTER_ADMIN_ID = 1735153058;

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

createApp({
    data() {
        return {
            ageVerified: localStorage.getItem('vape_age_v7') === 'true',
            loading: true, view: 'home', profileTab: 'my',
            user: JSON.parse(localStorage.getItem('vape_user_v7')) || null,
            items: [], dbUsers: [], userMap: {},
            settings: { announcement: '' },
            categories: ['–í—Å–µ', '–ü–æ–¥—ã', '–ú–æ–¥—ã', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ó–∞–ø—á–∞—Å—Ç–∏', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'],
            filters: { cat: '–í—Å–µ' }, searchQuery: '',
            auth: { name: '' }, verifyCode: '',
            newItem: { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '' },
            editUser: { name: '', bio: '' },
            publishing: false, selectedItem: null
        }
    },
    computed: {
        isAdmin() { return this.user && (this.user.is_admin || this.user.tg_id == MASTER_ADMIN_ID); },
        marketVolume() { return this.items.reduce((sum, i) => sum + (i.price || 0), 0); },
        hotItems() { return this.items.filter(i => i.status !== 'sold').slice(0, 5); },
        sortedItems() {
            const q = this.searchQuery.toLowerCase().trim();
            return this.items.filter(i => {
                const matchCat = this.filters.cat === '–í—Å–µ' || i.category === this.filters.cat;
                const matchSearch = !q || i.title.toLowerCase().includes(q) || i.city.toLowerCase().includes(q);
                return matchCat && matchSearch;
            }).sort((a,b) => b.id - a.id);
        },
        myItems() { return this.user ? this.items.filter(i => i.user_id === this.user.id) : []; },
        favoriteItems() {
            const favIds = this.user ? (this.user.favorites || []) : [];
            return this.items.filter(i => favIds.includes(i.id));
        }
    },
    async mounted() {
        if (this.ageVerified) await this.init();
        else this.loading = false;
        
        client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, () => this.fetchData()).subscribe();
        client.channel('any_users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => this.fetchData()).subscribe();
    },
    methods: {
        async init() {
            this.loading = true;
            await this.fetchData();
            await this.fetchSettings();
            this.loading = false;
        },
        async fetchData() {
            const { data: it } = await client.from('items').select('*').order('id', {ascending: false});
            const { data: us } = await client.from('users').select('*');
            this.items = it || [];
            this.dbUsers = us || [];
            const map = {};
            this.dbUsers.forEach(u => map[u.id] = u);
            this.userMap = map;

            if (this.user) {
                const fresh = this.dbUsers.find(u => u.id === this.user.id);
                if (fresh) {
                    this.user = fresh;
                    this.editUser.name = fresh.name;
                    this.editUser.bio = fresh.bio || '';
                    localStorage.setItem('vape_user_v7', JSON.stringify(this.user));
                    if (fresh.is_banned) this.logout();
                }
            }
        },
        async fetchSettings() {
            const { data } = await client.from('settings').select('*').eq('id', 1).single();
            if (data) this.settings = data;
        },
        verifyAge() { this.ageVerified = true; localStorage.setItem('vape_age_v7', 'true'); this.init(); },
        async toggleFavorite(id) {
            if (!this.user) return this.view = 'auth';
            let favs = [...(this.user.favorites || [])];
            if (favs.includes(id)) favs = favs.filter(f => f !== id);
            else favs.push(id);
            await client.from('users').update({ favorites: favs }).eq('id', this.user.id);
            this.user.favorites = favs;
            await this.fetchData();
        },
        isFavorite(id) { return this.user && this.user.favorites && this.user.favorites.includes(id); },
        async toggleSold(item) {
            const newStatus = item.status === 'sold' ? 'active' : 'sold';
            await client.from('items').update({ status: newStatus }).eq('id', item.id);
            await this.fetchData();
        },
        async saveProfile() {
            await client.from('users').update({ name: this.editUser.name, bio: this.editUser.bio }).eq('id', this.user.id);
            alert("–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω üíé");
            await this.fetchData();
        },
        async deleteItem(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { await client.from('items').delete().eq('id', id); await this.fetchData(); } },
        openItem(item) { this.selectedItem = item; this.view = 'product'; window.scrollTo(0,0); },
        contactSeller() { window.open(`https://t.me/${this.selectedItem.tg_user.replace('@', '')}`, '_blank'); },
        logout() { this.user = null; localStorage.removeItem('vape_user_v7'); this.view = 'home'; },
        // Auth, Uploads –∏ –ø—Ä–æ—á–∏–µ –±–∞–∑–æ–≤—ã–µ –º–µ—Ç–æ–¥—ã (—Ç–∞–∫–∏–µ –∂–µ –∫–∞–∫ —Ä–∞–Ω—å—à–µ, –Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–¥ v7)
        async startAuth() {
            this.verifyCode = Math.floor(1000 + Math.random() * 9000).toString();
            const poll = setInterval(async () => {
                const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-1`);
                const data = await res.json();
                const msg = data.result.find(u => u.message && u.message.text === this.verifyCode);
                if (msg) { clearInterval(poll); this.finalizeAuth(msg.message.from); }
            }, 3000);
        },
        async finalizeAuth(tg) {
            let { data: user } = await client.from('users').select('*').eq('tg_id', tg.id).single();
            if (!user) {
                const { data: newUser } = await client.from('users').insert([{ tg_id: tg.id, name: this.auth.name, is_admin: tg.id == MASTER_ADMIN_ID }]).select().single();
                user = newUser;
            }
            this.user = user;
            localStorage.setItem('vape_user_v7', JSON.stringify(this.user));
            this.view = 'home'; await this.fetchData();
        },
        triggerFile() { this.$refs.file1.click() },
        handleFileUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (f) => {
                const img = new Image(); img.src = f.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 800 / img.width;
                    canvas.width = 800; canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    this.newItem.img = canvas.toDataURL('image/jpeg', 0.7);
                }
            };
            reader.readAsDataURL(file);
        },
        async createListing() {
            this.publishing = true;
            await client.from('items').insert([{ ...this.newItem, user_id: this.user.id, seller_name: this.user.name }]);
            this.publishing = false; this.view = 'home'; await this.fetchData();
            this.newItem = { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '' };
        }
    }
}).mount('#app')
</script>

<style>
/* –ë–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –±–∞–Ω–Ω–µ—Ä–∞ */
@keyframes marquee {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}
</style>

</body>
</html>
