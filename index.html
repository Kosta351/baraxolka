<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–∞—Ä–∞—Ö–æ–ª–∫–∞ Pro | Cloud Edition</title>
    
    <!-- –§–∞–≤–∏–∫–æ–Ω -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%2300ffaa%22/><text y=%22.85em%22 x=%2250%%22 font-size=%2270%22 font-weight=%22900%22 text-anchor=%22middle%22 font-family=%22Arial%22 fill=%22black%22>B</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700;900&family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --neon: #00ffaa; --bg: #050505; --text: #e5e7eb; --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.1); }
        body { font-family: 'Manrope', sans-serif; background-color: var(--bg); color: var(--text); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .font-brand { font-family: 'Unbounded', sans-serif; }
        
        /* –£–ª—É—á—à–µ–Ω–Ω—ã–π Glassmorphism */
        .glass { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); }
        
        /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ */
        .btn-neon { background: var(--neon); color: #000; font-weight: 800; transition: all 0.3s ease; border-radius: 1.5rem; }
        .btn-neon:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-neon:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 255, 170, 0.4); }

        /* –ö–∞—Å—Ç–æ–º–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }

        input, select, textarea { 
            background: rgba(255,255,255,0.05) !important; 
            border: 1px solid var(--border) !important; 
            color: #fff !important; 
            outline: none !important;
            transition: all 0.2s ease;
        }
        input:focus { border-color: var(--neon) !important; box-shadow: 0 0 10px rgba(0,255,170,0.1); }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-item { opacity: 0.4; transition: 0.3s; }
        .nav-item.active { opacity: 1; color: var(--neon); }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body class="pb-32">

<div id="app" v-cloak>
    
    <!-- 1. AGE GATE -->
    <transition enter-active-class="animate__animated animate__fadeIn" leave-active-class="animate__animated animate__fadeOut">
        <div v-if="!ageVerified" class="fixed inset-0 z-[2000] bg-[#050505] flex items-center justify-center p-8 text-center">
            <div class="max-w-xs w-full">
                <div class="w-20 h-20 bg-[#00ffaa] rounded-3xl mx-auto mb-8 flex items-center justify-center text-black text-4xl font-black shadow-[0_0_50px_rgba(0,255,170,0.3)]">B</div>
                <h1 class="font-brand text-2xl mb-4 text-white uppercase italic">–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø–∞</h1>
                <p class="text-gray-400 text-sm mb-10">–í–∞–º —É–∂–µ –∏—Å–ø–æ–ª–Ω–∏–ª–æ—Å—å 18 –ª–µ—Ç? –ö–æ–Ω—Ç–µ–Ω—Ç –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–≤–∞—Ä—ã 18+.</p>
                <button @click="verifyAge" class="btn-neon w-full py-5 text-sm uppercase font-black tracking-widest">–î–∞, –≤–æ–π—Ç–∏</button>
            </div>
        </div>
    </transition>

    <div v-else>
        <!-- Loading Bar -->
        <div v-if="loading" class="fixed top-0 left-0 w-full h-1 bg-[#00ffaa]/20 z-[3000]">
            <div class="h-full bg-[#00ffaa] animate-[progress_2s_infinite]"></div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="fixed top-6 right-6 z-[2500] space-y-3">
            <transition-group name="animate__animated" enter-active-class="animate__fadeInRight" leave-active-class="animate__fadeOutRight">
                <div v-for="t in toasts" :key="t.id" class="glass px-6 py-4 rounded-2xl border-l-4 border-[#00ffaa] text-[11px] font-bold shadow-2xl min-w-[200px]">
                    {{ t.msg }}
                </div>
            </transition-group>
        </div>

        <!-- –®–ê–ü–ö–ê -->
        <header class="sticky top-0 z-50 glass border-b px-4 py-3">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <div @click="view = 'home'" class="flex items-center gap-2 cursor-pointer group">
                    <div class="w-10 h-10 bg-[#00ffaa] text-black rounded-xl flex items-center justify-center font-brand font-black group-hover:rotate-12 transition-transform">B</div>
                    <span class="font-brand text-lg italic tracking-tighter uppercase hidden sm:block">–ë–ê–†–ê–•–û–õ–ö–ê</span>
                </div>
                
                <div class="flex items-center gap-4">
                    <div v-if="user" @click="view = 'profile'" class="flex items-center gap-3 cursor-pointer glass p-1 pr-4 rounded-full">
                        <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-8 h-8 rounded-full object-cover">
                        <span class="text-[10px] font-black uppercase">{{ user.name }}</span>
                    </div>
                    <button v-else @click="view = 'auth'" class="btn-neon px-6 py-2 text-[10px] uppercase">–í—Ö–æ–¥</button>
                </div>
            </div>
        </header>

        <main class="max-w-6xl mx-auto px-4 pt-6">
            <transition name="animate__animated" enter-active-class="animate__fadeIn animate__faster" mode="out-in">

                <!-- –í–ò–¢–†–ò–ù–ê -->
                <div v-if="view === 'home'" key="home">
                    <!-- –ü–æ–∏—Å–∫ –∏ –§–∏–ª—å—Ç—Ä—ã -->
                    <div class="mb-8 space-y-4">
                        <div class="relative group">
                            <input v-model="searchQuery" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –≥–æ—Ä–æ–¥—É..." class="w-full pl-12 pr-4 py-4 rounded-2xl glass transition-all">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 opacity-30 group-focus-within:opacity-100 transition-opacity">üîç</span>
                        </div>
                        <div class="flex gap-2 overflow-x-auto pb-2 scroll-hide">
                            <button v-for="c in categories" 
                                    @click="filters.cat = c" 
                                    :class="filters.cat === c ? 'bg-[#00ffaa] text-black' : 'glass opacity-60'"
                                    class="px-5 py-2 rounded-full text-[10px] font-black uppercase whitespace-nowrap transition-all">
                                {{ c }}
                            </button>
                        </div>
                    </div>

                    <!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
                    <div v-if="sortedItems.length" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                        <div v-for="item in sortedItems" :key="item.id" @click="openItem(item)" 
                             class="glass rounded-[2rem] p-3 relative group cursor-pointer hover:border-[#00ffaa]/50 transition-all">
                            
                            <div class="aspect-square rounded-[1.5rem] overflow-hidden mb-3 bg-black/40">
                                <img :src="item.img" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" loading="lazy">
                                <div v-if="item.status === 'sold'" class="absolute inset-0 bg-black/60 flex items-center justify-center">
                                    <span class="border-2 border-red-500 text-red-500 px-2 py-1 rounded text-[10px] font-bold uppercase -rotate-12">–ü—Ä–æ–¥–∞–Ω–æ</span>
                                </div>
                            </div>

                            <div class="px-2">
                                <h3 class="text-[11px] font-extrabold truncate uppercase mb-1">{{item.title}}</h3>
                                <div class="flex justify-between items-center">
                                    <span class="text-[#00ffaa] font-brand text-[12px]">{{item.price.toLocaleString()}} ‚ÇΩ</span>
                                    <div class="flex gap-1 text-[10px]">
                                        <span v-if="userMap[item.user_id]?.has_crown">üëë</span>
                                        <span v-if="userMap[item.user_id]?.is_verified">‚úÖ</span>
                                    </div>
                                </div>
                                <div class="text-[8px] opacity-40 uppercase font-bold mt-2">{{item.city}}</div>
                            </div>
                        </div>
                    </div>
                    <div v-else class="text-center py-20 opacity-30">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ...</div>
                </div>

                <!-- –ü–†–û–°–ú–û–¢–† –õ–û–¢–ê -->
                <div v-else-if="view === 'product' && selectedItem" class="max-w-4xl mx-auto" key="product">
                    <button @click="view = 'home'" class="mb-6 opacity-50 hover:opacity-100 flex items-center gap-2 text-xs">‚Üê –ù–∞–∑–∞–¥</button>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- –ì–∞–ª–µ—Ä–µ—è -->
                        <div class="space-y-4">
                            <img :src="activeImg || selectedItem.img" class="w-full aspect-square object-cover rounded-[3rem] shadow-2xl glass">
                            <div class="flex gap-2">
                                <img v-for="pic in [selectedItem.img, selectedItem.img2, selectedItem.img3].filter(i => i)" 
                                     :src="pic" @click="activeImg = pic"
                                     :class="activeImg === pic ? 'border-[#00ffaa]' : 'border-transparent'"
                                     class="w-16 h-16 rounded-xl object-cover cursor-pointer border-2 glass">
                            </div>
                        </div>
                        
                        <!-- –ò–Ω—Ñ–æ -->
                        <div>
                            <div class="flex gap-2 mb-4">
                                <span class="bg-white/5 px-3 py-1 rounded-full text-[9px] uppercase font-bold">{{selectedItem.category}}</span>
                                <span v-if="selectedItem.status === 'sold'" class="bg-red-500/10 text-red-500 px-3 py-1 rounded-full text-[9px] uppercase font-bold">–ü—Ä–æ–¥–∞–Ω–æ</span>
                            </div>
                            <h1 class="text-3xl font-black italic uppercase mb-2">{{selectedItem.title}}</h1>
                            <div class="text-3xl font-brand text-[#00ffaa] mb-8">{{selectedItem.price.toLocaleString()}} ‚ÇΩ</div>
                            
                            <div class="glass p-4 rounded-2xl mb-6 flex items-center gap-4">
                                <img :src="userMap[selectedItem.user_id]?.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${selectedItem.user_id}`" class="w-12 h-12 rounded-xl">
                                <div>
                                    <div class="text-sm font-black uppercase">{{selectedItem.seller_name}}</div>
                                    <div class="text-[9px] opacity-50">–ü—Ä–æ–¥–∞–≤–µ—Ü –Ω–∞ –ë–∞—Ä–∞—Ö–æ–ª–∫–µ</div>
                                </div>
                            </div>

                            <p class="text-gray-400 text-sm leading-relaxed mb-8">{{selectedItem.desc_text || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.'}}</p>
                            
                            <button @click="contactSeller" :disabled="selectedItem.status === 'sold'" 
                                    class="btn-neon w-full py-5 text-xs font-black uppercase tracking-widest shadow-lg">
                                {{ selectedItem.status === 'sold' ? '–¢–æ–≤–∞—Ä –ø—Ä–æ–¥–∞–Ω' : '–ù–∞–ø–∏—Å–∞—Ç—å –≤ Telegram' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –ü–†–û–§–ò–õ–¨ -->
                <div v-else-if="view === 'profile' && user" class="max-w-2xl mx-auto" key="profile">
                    <div class="glass rounded-[3rem] p-8 text-center relative overflow-hidden">
                        <div class="absolute top-0 left-0 w-full h-2 bg-[#00ffaa]"></div>
                        
                        <div class="relative inline-block mb-6">
                            <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-32 h-32 rounded-[2.5rem] object-cover ring-4 ring-white/5">
                            <label class="absolute -bottom-2 -right-2 bg-[#00ffaa] text-black w-10 h-10 rounded-xl flex items-center justify-center cursor-pointer shadow-xl">
                                üì∑ <input type="file" @change="handleAvatarUpload" class="hidden" accept="image/*">
                            </label>
                        </div>
                        
                        <h2 class="text-2xl font-black uppercase italic">{{user.name}}</h2>
                        <div class="text-[10px] opacity-40 uppercase mb-6 tracking-[0.2em] font-bold">ID: {{user.tg_id}}</div>
                        
                        <div class="flex justify-center gap-4 mb-8">
                            <div class="glass px-6 py-2 rounded-2xl">
                                <div class="text-[10px] uppercase opacity-50 mb-1">–û–±—ä—è–≤–ª–µ–Ω–∏—è</div>
                                <div class="font-brand">{{ myItems.length }}</div>
                            </div>
                            <div v-if="user.strikes > 0" class="glass px-6 py-2 rounded-2xl border-red-500/30">
                                <div class="text-[10px] uppercase text-red-500 mb-1">–í–∞—Ä–Ω—ã</div>
                                <div class="font-brand text-red-500">{{ user.strikes }}/3</div>
                            </div>
                        </div>

                        <button @click="logout" class="text-red-500 text-[10px] font-black uppercase tracking-widest opacity-40 hover:opacity-100 transition-opacity">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                    </div>

                    <div class="mt-10">
                        <h3 class="font-brand text-sm uppercase italic mb-6">–ú–æ–∏ –ª–æ—Ç—ã</h3>
                        <div class="space-y-3">
                            <div v-for="item in myItems" :key="item.id" class="glass p-4 rounded-3xl flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <img :src="item.img" class="w-12 h-12 rounded-xl object-cover">
                                    <div>
                                        <div class="text-[11px] font-black uppercase">{{item.title}}</div>
                                        <div class="text-[10px] text-[#00ffaa]">{{item.price}} ‚ÇΩ</div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="toggleSold(item)" class="px-3 py-2 rounded-xl glass text-[9px] font-black uppercase" :class="item.status === 'sold' ? 'text-green-500' : 'text-gray-400'">
                                        {{ item.status === 'sold' ? '–í –ø—Ä–æ–¥–∞–∂–µ' : '–ü—Ä–æ–¥–∞–Ω–æ' }}
                                    </button>
                                    <button @click="deleteItem(item.id)" class="px-3 py-2 rounded-xl bg-red-500/10 text-red-500 text-[9px] font-black uppercase">–£–¥–∞–ª–∏—Ç—å</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –í–•–û–î -->
                <div v-else-if="view === 'auth'" class="max-w-md mx-auto py-10" key="auth">
                    <div class="glass p-10 rounded-[3.5rem] text-center border-t-4 border-sky-500">
                        <h2 class="font-brand text-2xl uppercase italic mb-8">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
                        
                        <div v-if="authStep === 'input'" class="space-y-4">
                            <input v-model="auth.name" type="text" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–∏–∫–Ω–µ–π–º" class="w-full p-4 rounded-2xl text-center font-bold">
                            <button @click="startAuth" :disabled="!auth.name" class="btn-neon w-full py-5 uppercase text-xs">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
                        </div>
                        
                        <div v-else class="space-y-6 animate__animated animate__fadeIn">
                            <div class="text-5xl font-brand text-[#00ffaa] py-6 glass rounded-3xl tracking-tighter">{{verifyCode}}</div>
                            <p class="text-[10px] text-gray-400 leading-relaxed px-6 uppercase font-bold">
                                –û—Ç–ø—Ä–∞–≤—å —ç—Ç–æ—Ç –∫–æ–¥ –Ω–∞—à–µ–º—É –±–æ—Ç—É: <br>
                                <a href="https://t.me/your_vape_bot" target="_blank" class="text-sky-400 border-b border-sky-400/30">@your_vape_bot</a>
                            </p>
                            <div class="animate-pulse text-[10px] text-[#00ffaa] uppercase">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –±–æ—Ç–∞...</div>
                        </div>
                    </div>
                </div>

                <!-- –î–û–ë–ê–í–õ–ï–ù–ò–ï –õ–û–¢–ê -->
                <div v-else-if="view === 'add'" class="max-w-2xl mx-auto pb-10" key="add">
                    <div class="glass p-8 rounded-[3.5rem]">
                        <h2 class="font-brand text-xl uppercase italic mb-8 text-center">–°–æ–∑–¥–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ</h2>
                        <div class="space-y-4">
                            <!-- –§–æ—Ç–æ -->
                            <div class="grid grid-cols-3 gap-3 mb-4">
                                <div v-for="n in [1,2,3]" :key="n" @click="triggerFile(n)" 
                                     class="aspect-square glass rounded-2xl flex flex-col items-center justify-center cursor-pointer border-2 border-dashed border-white/10 hover:border-[#00ffaa]/40 transition-all overflow-hidden relative">
                                    <img v-if="getNewImg(n)" :src="getNewImg(n)" class="w-full h-full object-cover">
                                    <div v-else class="text-center">
                                        <span class="text-xl block">üì∏</span>
                                        <span class="text-[8px] font-bold opacity-40">–§–û–¢–û {{n}}</span>
                                    </div>
                                    <input type="file" :ref="'file'+n" @change="e => handleFileUpload(e, n)" class="hidden" accept="image/*">
                                </div>
                            </div>
                            
                            <input v-model="newItem.title" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" class="w-full p-4 rounded-2xl font-bold">
                            
                            <div class="grid grid-cols-2 gap-4">
                                <select v-model="newItem.category" class="p-4 rounded-2xl font-bold text-xs uppercase">
                                    <option v-for="c in categories.filter(x => x !== '–í—Å–µ')" :value="c">{{c}}</option>
                                </select>
                                <input v-model.number="newItem.price" type="number" placeholder="–¶–µ–Ω–∞ ‚ÇΩ" class="p-4 rounded-2xl font-brand text-sm">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <input v-model="newItem.city" type="text" placeholder="–ì–æ—Ä–æ–¥" class="p-4 rounded-2xl text-sm">
                                <input v-model="newItem.tg_user" type="text" placeholder="–¢–≤–æ–π @username" class="p-4 rounded-2xl text-sm">
                            </div>

                            <textarea v-model="newItem.desc_text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ: —Å–æ—Å—Ç–æ—è–Ω–∏–µ, –∫–æ–º–ø–ª–µ–∫—Ç, –¥–µ—Ñ–µ–∫—Ç—ã..." class="w-full h-32 p-4 rounded-2xl text-sm"></textarea>
                            
                            <button @click="createListing" :disabled="publishing || !newItem.img" class="btn-neon w-full py-6 uppercase font-black tracking-widest text-xs">
                                {{ publishing ? '–ü—É–±–ª–∏–∫–∞—Ü–∏—è...' : '–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ' }}
                            </button>
                        </div>
                    </div>
                </div>

            </transition>
        </main>

        <!-- –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
        <nav class="fixed bottom-6 inset-x-6 z-[100] max-w-md mx-auto">
            <div class="glass rounded-[2.5rem] p-3 flex justify-between items-center shadow-2xl backdrop-blur-3xl border-white/10">
                <button @click="view = 'home'" :class="{active: view === 'home'}" class="nav-item flex-1 flex flex-col items-center py-2">
                    <span class="text-xl">üè†</span>
                    <span class="text-[8px] font-black uppercase mt-1">–í–∏—Ç—Ä–∏–Ω–∞</span>
                </button>
                <button @click="user ? view = 'add' : view = 'auth'" :class="{active: view === 'add'}" class="nav-item flex-1 flex flex-col items-center py-2">
                    <span class="text-xl">‚ûï</span>
                    <span class="text-[8px] font-black uppercase mt-1">–ü–æ–¥–∞—Ç—å</span>
                </button>
                <button @click="user ? view = 'profile' : view = 'auth'" :class="{active: view === 'profile'}" class="nav-item flex-1 flex flex-col items-center py-2">
                    <span class="text-xl">üë§</span>
                    <span class="text-[8px] font-black uppercase mt-1">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </button>
            </div>
        </nav>
    </div>
</div>

<script>
/**
 * –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨: –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ .env —Ñ–∞–π–ª—ã.
 * –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–∞–ø—Ä—è–º—É—é –≤ –±—Ä–∞—É–∑–µ—Ä–µ –∫–ª—é—á–∏ –æ—Å—Ç–∞—é—Ç—Å—è –∑–¥–µ—Å—å.
 */
const SUPABASE_URL = 'https://gcxnstwsqkmdotqblkfd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeG5zdHdzcWttZG90cWJsa2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDI3MzIsImV4cCI6MjA4MjM3ODczMn0.79gdNrKNRcdPTbban-6uK3GP5Czyq-II7kRHaRyfvqE';
const BOT_TOKEN = '7688454041:AAFFBc0Ye7RRq0RFuSst_QfTqQ0TpQu9aWI';
const MASTER_ADMIN_ID = 1735153058;

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const { createApp } = Vue;

createApp({
    data() {
        return {
            ageVerified: localStorage.getItem('vape_age_v3') === 'true',
            loading: true,
            view: 'home',
            user: JSON.parse(localStorage.getItem('vape_user_v3')),
            items: [],
            dbUsers: [],
            userMap: {}, // –î–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
            categories: ['–í—Å–µ', '–ü–æ–¥—ã', '–ú–æ–¥—ã', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ó–∞–ø—á–∞—Å—Ç–∏', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'],
            filters: { cat: '–í—Å–µ' },
            searchQuery: '',
            toasts: [],
            authStep: 'input',
            auth: { name: '' },
            verifyCode: '',
            newItem: { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '', img2: '', img3: '' },
            publishing: false,
            selectedItem: null,
            activeImg: null
        }
    },
    computed: {
        // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        sortedItems() {
            const q = this.searchQuery.toLowerCase().trim();
            return this.items.filter(i => {
                const matchCat = this.filters.cat === '–í—Å–µ' || i.category === this.filters.cat;
                const matchSearch = !q || i.title.toLowerCase().includes(q) || i.city.toLowerCase().includes(q);
                return matchCat && matchSearch;
            }).sort((a, b) => b.id - a.id);
        },
        myItems() {
            return this.user ? this.items.filter(i => i.user_id === this.user.id) : [];
        }
    },
    async mounted() {
        if (this.ageVerified) await this.init();
        else this.loading = false;

        // Realtime –ø–æ–¥–ø–∏—Å–∫–∏
        client.channel('public:items').on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, () => this.fetchData()).subscribe();
        client.channel('public:users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => this.fetchData()).subscribe();
    },
    methods: {
        async init() {
            this.loading = true;
            await this.fetchData();
            this.loading = false;
        },
        async fetchData() {
            const { data: items } = await client.from('items').select('*').order('id', { ascending: false });
            const { data: users } = await client.from('users').select('*');
            
            this.items = items || [];
            this.dbUsers = users || [];
            
            // –°–æ–∑–¥–∞–µ–º Map –¥–ª—è O(1) –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            const map = {};
            this.dbUsers.forEach(u => map[u.id] = u);
            this.userMap = map;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ—Å—Å–∏–∏
            if (this.user) {
                const freshUser = this.dbUsers.find(u => u.id === this.user.id);
                if (freshUser) {
                    if (freshUser.is_banned) return this.logout();
                    this.user = freshUser;
                    localStorage.setItem('vape_user_v3', JSON.stringify(this.user));
                }
            }
        },
        notify(msg) {
            const id = Date.now();
            this.toasts.push({ id, msg });
            setTimeout(() => this.toasts = this.toasts.filter(t => t.id !== id), 3000);
        },
        verifyAge() {
            this.ageVerified = true;
            localStorage.setItem('vape_age_v3', 'true');
            this.init();
        },
        async startAuth() {
            if (this.auth.name.length < 2) return this.notify('–ù–∏–∫ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π');
            this.verifyCode = Math.floor(1000 + Math.random() * 9000).toString();
            this.authStep = 'telegram';

            // –ü–æ–ª–ª–∏–Ω–≥ Telegram (getUpdates)
            const poll = setInterval(async () => {
                if (this.view !== 'auth') clearInterval(poll);
                try {
                    const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-1`);
                    const data = await res.json();
                    const msg = data.result.find(u => u.message && u.message.text === this.verifyCode);
                    
                    if (msg) {
                        clearInterval(poll);
                        await this.finalizeAuth(msg.message.from);
                    }
                } catch (e) { console.error("Polling error", e); }
            }, 3000);
        },
        async finalizeAuth(tg) {
            let { data: user } = await client.from('users').select('*').eq('tg_id', tg.id).single();
            
            if (!user) {
                const { data: newUser } = await client.from('users').insert([{
                    tg_id: tg.id,
                    name: this.auth.name,
                    tg_name: tg.username || tg.first_name,
                    is_admin: tg.id === MASTER_ADMIN_ID
                }]).select().single();
                user = newUser;
            }
            
            this.user = user;
            localStorage.setItem('vape_user_v3', JSON.stringify(this.user));
            this.notify(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.name}!`);
            this.view = 'home';
            await this.fetchData();
        },
        async handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const base64 = await this.compressImage(file, 300);
            const { error } = await client.from('users').update({ avatar: base64 }).eq('id', this.user.id);
            if (!error) {
                this.user.avatar = base64;
                this.notify('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!');
                await this.fetchData();
            }
        },
        triggerFile(n) { this.$refs['file'+n][0].click(); },
        getNewImg(n) {
            return n === 1 ? this.newItem.img : n === 2 ? this.newItem.img2 : this.newItem.img3;
        },
        async handleFileUpload(e, n) {
            const file = e.target.files[0];
            if (!file) return;
            const base64 = await this.compressImage(file, 800);
            if(n === 1) this.newItem.img = base64;
            if(n === 2) this.newItem.img2 = base64;
            if(n === 3) this.newItem.img3 = base64;
        },
        compressImage(file, maxWidth) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        },
        async createListing() {
            this.publishing = true;
            const { error } = await client.from('items').insert([{
                ...this.newItem,
                user_id: this.user.id,
                seller_name: this.user.name,
                status: 'active'
            }]);
            
            if (!error) {
                this.notify('–õ–æ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
                this.view = 'home';
                this.newItem = { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '', img2: '', img3: '' };
            } else {
                this.notify('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏');
            }
            this.publishing = false;
        },
        async toggleSold(item) {
            const newStatus = item.status === 'sold' ? 'active' : 'sold';
            await client.from('items').update({ status: newStatus }).eq('id', item.id);
            this.notify(newStatus === 'sold' ? '–ü–æ–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ–¥–∞–Ω–æ' : '–°–Ω–æ–≤–∞ –≤ –ø—Ä–æ–¥–∞–∂–µ');
            await this.fetchData();
        },
        async deleteItem(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ?')) return;
            await client.from('items').delete().eq('id', id);
            this.notify('–£–¥–∞–ª–µ–Ω–æ');
            await this.fetchData();
        },
        openItem(item) {
            this.selectedItem = item;
            this.activeImg = item.img;
            this.view = 'product';
            window.scrollTo(0, 0);
        },
        contactSeller() {
            const user = this.selectedItem.tg_user.replace('@', '');
            window.open(`https://t.me/${user}`, '_blank');
        },
        logout() {
            this.user = null;
            localStorage.removeItem('vape_user_v3');
            this.view = 'home';
            this.notify('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        }
    }
}).mount('#app');
</script>
</body>
</html>
