<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bazar Premium | Next Gen</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Manrope:wght@400;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --accent: #00ffaa; --bg: #030303; --card: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08); }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); color: #fff; overflow-x: hidden; background-image: radial-gradient(circle at 50% -20%, #00ffaa15, transparent); }
        .font-brand { font-family: 'Unbounded', sans-serif; }
        .glass { background: var(--card); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid var(--border); }
        .btn-prime { background: linear-gradient(135deg, var(--accent), #00d4ff); color: #000; font-weight: 800; box-shadow: 0 10px 30px -10px rgba(0, 255, 170, 0.5); transition: 0.3s; border-radius: 1.5rem; }
        .skeleton { background: linear-gradient(90deg, #111 25%, #222 50%, #111 75%); background-size: 200% 100%; animation: skeleton-loading 1.5s infinite; }
        @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        [v-cloak] { display: none; }
        .category-chip.active { background: var(--accent); color: #000; }
        .tab-bar-item { opacity: 0.4; transition: 0.3s; cursor: pointer; }
        .tab-bar-item.active { color: var(--accent); opacity: 1; transform: translateY(-3px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <!-- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò -->
    <div v-if="loading" class="p-6 space-y-6">
        <div class="h-20 skeleton rounded-[2rem]"></div>
        <div class="grid grid-cols-2 gap-4">
            <div v-for="i in 4" :key="i" class="h-60 skeleton rounded-[2.5rem]"></div>
        </div>
    </div>

    <div v-else class="animate__animated animate__fadeIn">
        
        <!-- –•–ï–î–ï–† -->
        <header class="p-6">
            <div class="flex justify-between items-center mb-6">
                <div @click="view = 'home'" class="cursor-pointer">
                    <h1 class="font-brand text-2xl font-black italic tracking-tighter">BAZAR<span class="text-[#00ffaa]">.</span></h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="w-1.5 h-1.5 bg-[#00ffaa] rounded-full animate-pulse"></span>
                        <span class="text-[9px] font-bold opacity-40 uppercase tracking-widest">{{ items.length }} —Ç–æ–≤–∞—Ä–æ–≤ –æ–Ω–ª–∞–π–Ω</span>
                    </div>
                </div>
                <div v-if="user" @click="view = 'profile'" class="w-12 h-12 rounded-2xl glass p-1 cursor-pointer overflow-hidden">
                    <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-full h-full object-cover rounded-xl">
                </div>
                <button v-else @click="view = 'auth'" class="btn-prime px-6 py-2 text-[10px] uppercase">–í–æ–π—Ç–∏</button>
            </div>
        </header>

        <main class="px-6 pb-32">
            <!-- –í–ò–¢–†–ò–ù–ê -->
            <div v-if="view === 'home'">
                <div class="mb-8 space-y-4">
                    <div class="glass rounded-[2rem] flex items-center px-6 py-1">
                        <input v-model="searchQuery" type="text" placeholder="–ù–∞–π—Ç–∏ –¥–µ–≤–∞–π—Å..." class="bg-transparent border-none w-full p-4 text-sm focus:ring-0 text-white placeholder:text-white/20">
                    </div>
                    <div class="flex gap-2 overflow-x-auto no-scrollbar pb-2">
                        <div v-for="c in categories" :key="c" @click="filters.cat = c" 
                            :class="['px-6 py-3 rounded-full text-[10px] font-black uppercase glass whitespace-nowrap transition-all', {active: filters.cat === c}]">
                            {{c}}
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div v-for="item in sortedItems" :key="item.id" @click="openItem(item)" class="glass rounded-[2.5rem] p-3 relative group active:scale-95 transition-transform">
                        <div class="aspect-square rounded-[1.8rem] overflow-hidden mb-3 bg-black/40">
                            <img :src="item.img" class="w-full h-full object-cover">
                        </div>
                        <h3 class="text-[11px] font-black uppercase truncate px-2">{{item.title}}</h3>
                        <div class="flex justify-between items-center px-2">
                            <span class="text-[#00ffaa] font-brand text-[12px]">{{item.price}} ‚ÇΩ</span>
                            <span v-if="userMap[item.user_id]?.has_crown">üëë</span>
                        </div>
                    </div>
                </div>
                <div v-if="items.length === 0" class="text-center py-20 opacity-20 text-[10px] uppercase font-black">–¢–æ–≤–∞—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>
            </div>

            <!-- –ü–†–û–§–ò–õ–¨ -->
            <div v-else-if="view === 'profile' && user" class="animate__animated animate__fadeInUp">
                <div v-if="isAdmin" @click="view = 'admin'" class="mb-4 p-4 rounded-3xl bg-[#ff3366] text-white text-center font-black text-[10px] uppercase cursor-pointer">
                    –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å üõ†Ô∏è
                </div>
                <div class="glass p-10 rounded-[3rem] text-center">
                    <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-24 h-24 rounded-3xl mx-auto mb-6 object-cover">
                    <h2 class="font-brand text-xl uppercase italic">{{user.name}}</h2>
                    <p class="text-[9px] opacity-40 uppercase font-black mt-2">ID: {{user.tg_id}}</p>
                    <button @click="logout" class="mt-10 text-red-500 text-[10px] uppercase font-black opacity-40">–í—ã—Ö–æ–¥</button>
                </div>
            </div>

            <!-- –ê–î–ú–ò–ù–ö–ê -->
            <div v-else-if="view === 'admin' && isAdmin" class="space-y-4">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-brand text-xl text-[#ff3366] uppercase italic">Admin</h2>
                    <button @click="view = 'profile'" class="text-[10px] glass px-4 py-2 rounded-xl uppercase">–ù–∞–∑–∞–¥</button>
                </div>
                <div v-for="u in dbUsers" :key="u.id" class="glass p-4 rounded-3xl flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img :src="u.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${u.name}`" class="w-10 h-10 rounded-xl object-cover">
                        <div class="text-[10px] font-black uppercase">{{u.name}} <span v-if="u.has_crown">üëë</span></div>
                    </div>
                    <div class="flex gap-1">
                        <button @click="toggleCrown(u)" class="p-2 glass rounded-lg text-xs">{{u.has_crown ? 'üëë' : '‚ö™'}}</button>
                        <button @click="banUser(u)" class="p-2 glass text-red-500 rounded-lg text-[8px] font-black">–ë–ê–ù</button>
                    </div>
                </div>
            </div>

            <!-- –í–•–û–î -->
            <div v-else-if="view === 'auth'" class="max-w-md mx-auto py-10 text-center">
                <div class="glass p-12 rounded-[3.5rem]">
                    <h2 class="font-brand text-3xl uppercase mb-10 italic">–í—Ö–æ–¥</h2>
                    <input v-model="auth.name" type="text" placeholder="–¢–≤–æ–π –Ω–∏–∫" class="w-full p-5 glass rounded-2xl mb-4 text-center text-white font-bold">
                    <button @click="startAuth" class="btn-prime w-full py-6 rounded-2xl uppercase text-[10px] tracking-widest">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
                    <div v-if="verifyCode" class="mt-10 animate__animated animate__fadeIn">
                        <div class="text-5xl font-brand text-[#00ffaa] mb-4">{{verifyCode}}</div>
                        <p class="text-[9px] opacity-40 uppercase font-black">–û—Ç–ø—Ä–∞–≤—å —ç—Ç–æ—Ç –∫–æ–¥ –±–æ—Ç—É:<br><a href="https://t.me/your_vape_bot" class="text-[#00ffaa]">@your_vape_bot</a></p>
                    </div>
                </div>
            </div>

            <!-- –î–û–ë–ê–í–õ–ï–ù–ò–ï -->
            <div v-else-if="view === 'add'" class="max-w-xl mx-auto">
                <div class="glass p-8 rounded-[3rem] space-y-4">
                    <h2 class="font-brand text-xl uppercase text-center mb-4 italic">–ù–æ–≤—ã–π –ª–æ—Ç</h2>
                    <div @click="triggerFile" class="aspect-square glass rounded-3xl flex flex-col items-center justify-center cursor-pointer overflow-hidden border-2 border-dashed border-white/10">
                        <img v-if="newItem.img" :src="newItem.img" class="w-full h-full object-cover">
                        <span v-else class="text-4xl opacity-20">üì∏</span>
                        <input type="file" ref="file1" @change="handleFileUpload" class="hidden" accept="image/*">
                    </div>
                    <input v-model="newItem.title" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="w-full p-4 glass rounded-2xl text-white text-sm">
                    <input v-model.number="newItem.price" type="number" placeholder="–¶–µ–Ω–∞ ‚ÇΩ" class="w-full p-4 glass rounded-2xl text-white font-brand text-xs">
                    <input v-model="newItem.city" type="text" placeholder="–¢–≤–æ–π –≥–æ—Ä–æ–¥" class="w-full p-4 glass rounded-2xl text-white text-sm">
                    <input v-model="newItem.tg_user" type="text" placeholder="Telegram –Ω–∏–∫ (–±–µ–∑ @)" class="w-full p-4 glass rounded-2xl text-white text-sm">
                    <textarea v-model="newItem.desc_text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." class="w-full p-4 glass rounded-2xl h-32 text-white text-sm"></textarea>
                    <button @click="createListing" :disabled="publishing || !newItem.img" class="btn-prime w-full py-6 text-[10px] uppercase font-black tracking-widest">
                        {{ publishing ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å' }}
                    </button>
                </div>
            </div>
        </main>

        <!-- –ú–ï–ù–Æ -->
        <nav class="fixed bottom-8 inset-x-8 z-[100] max-w-sm mx-auto">
            <div class="glass rounded-[2.5rem] p-3 flex justify-around items-center shadow-2xl backdrop-blur-3xl border-white/10">
                <button @click="view = 'home'" :class="['tab-bar-item p-3', {active: view === 'home'}]">üè†</button>
                <button @click="user ? view = 'add' : view = 'auth'" :class="['tab-bar-item p-3', {active: view === 'add'}]">‚ûï</button>
                <button @click="user ? (view = 'profile' || view === 'admin') : view = 'auth'" :class="['tab-bar-item p-3', {active: view === 'profile' || view === 'admin'}]">üë§</button>
            </div>
        </nav>
    </div>
</div>

<script>
const { createApp } = Vue;

// –î–ê–ù–ù–´–ï –í–°–¢–ê–í–õ–ï–ù–´ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò
const SUPABASE_URL = 'https://gcxnstwsqkmdotqblkfd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeG5zdHdzcWttZG90cWJsa2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDI3MzIsImV4cCI6MjA4MjM3ODczMn0.79gdNrKNRcdPTbban-6uK3GP5Czyq-II7kRHaRyfvqE';
const BOT_TOKEN = '7688454041:AAFFBc0Ye7RRq0RFuSst_QfTqQ0TpQu9aWI';
const MASTER_ADMIN_ID = 1735153058;

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

createApp({
    data() {
        return {
            loading: true, view: 'home',
            user: JSON.parse(localStorage.getItem('vape_user_v5')) || null,
            items: [], dbUsers: [], userMap: {},
            categories: ['–í—Å–µ', '–ü–æ–¥—ã', '–ú–æ–¥—ã', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ó–∞–ø—á–∞—Å—Ç–∏'],
            filters: { cat: '–í—Å–µ' }, searchQuery: '',
            auth: { name: '' }, verifyCode: '',
            newItem: { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '' },
            publishing: false
        }
    },
    computed: {
        isCreator() { return this.user && this.user.tg_id == MASTER_ADMIN_ID; },
        isAdmin() { return this.user && (this.user.is_admin || this.isCreator); },
        sortedItems() {
            return this.items.filter(i => {
                const matchCat = this.filters.cat === '–í—Å–µ' || i.category === this.filters.cat;
                const matchSearch = i.title.toLowerCase().includes(this.searchQuery.toLowerCase());
                return matchCat && matchSearch;
            });
        },
        myItems() { return this.user ? this.items.filter(i => i.user_id === this.user.id) : []; }
    },
    async mounted() {
        await this.fetchData();
        setTimeout(() => { this.loading = false }, 2000);
        client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, () => this.fetchData()).subscribe();
        client.channel('any_users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => this.fetchData()).subscribe();
    },
    methods: {
        async fetchData() {
            try {
                const { data: it } = await client.from('items').select('*').order('id', {ascending: false});
                const { data: us } = await client.from('users').select('*');
                this.items = it || [];
                this.dbUsers = us || [];
                const map = {};
                this.dbUsers.forEach(u => map[u.id] = u);
                this.userMap = map;
                if (this.user) {
                    const fresh = this.dbUsers.find(u => u.id === this.user.id);
                    if (fresh) { this.user = fresh; localStorage.setItem('vape_user_v5', JSON.stringify(this.user)); }
                }
            } catch (e) { console.error(e) }
            finally { this.loading = false }
        },
        async startAuth() {
            this.verifyCode = Math.floor(1000 + Math.random() * 9000).toString();
            const poll = setInterval(async () => {
                if(this.view !== 'auth') clearInterval(poll);
                const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-1`);
                const data = await res.json();
                const msg = data.result.find(u => u.message && u.message.text === this.verifyCode);
                if (msg) { clearInterval(poll); this.finalizeAuth(msg.message.from); }
            }, 3000);
        },
        async finalizeAuth(tg) {
            let { data: user } = await client.from('users').select('*').eq('tg_id', tg.id).single();
            if (!user) {
                const { data: newUser } = await client.from('users').insert([{ 
                    tg_id: tg.id, name: this.auth.name, is_admin: tg.id == MASTER_ADMIN_ID 
                }]).select().single();
                user = newUser;
            }
            this.user = user;
            localStorage.setItem('vape_user_v5', JSON.stringify(this.user));
            this.view = 'home'; await this.fetchData();
        },
        triggerFile() { this.$refs.file1.click() },
        handleFileUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (f) => {
                const img = new Image(); img.src = f.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 800 / img.width;
                    canvas.width = 800; canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    this.newItem.img = canvas.toDataURL('image/jpeg', 0.7);
                }
            };
            reader.readAsDataURL(file);
        },
        async createListing() {
            this.publishing = true;
            await client.from('items').insert([{ ...this.newItem, user_id: this.user.id, seller_name: this.user.name }]);
            this.publishing = false; this.view = 'home'; await this.fetchData();
        },
        async deleteItem(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { await client.from('items').delete().eq('id', id); await this.fetchData(); } },
        async toggleCrown(u) { await client.from('users').update({ has_crown: !u.has_crown }).eq('id', u.id); await this.fetchData(); },
        async banUser(u) { await client.from('users').update({ is_banned: !u.is_banned }).eq('id', u.id); await this.fetchData(); },
        logout() { this.user = null; localStorage.removeItem('vape_user_v5'); this.view = 'home'; },
        openItem(item) { window.open(`https://t.me/${item.tg_user}`, '_blank'); }
    }
}).mount('#app')
</script>
</body>
</html>
