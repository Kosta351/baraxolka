<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–∞—Ä–∞—Ö–æ–ª–∫–∞ | Final Release</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 rx=%2220%22 fill=%22%2300ffaa%22/><text y=%22.85em%22 x=%2250%%22 font-size=%2270%22 font-weight=%22900%22 text-anchor=%22middle%22 font-family=%22Arial%22 fill=%22black%22>B</text></svg>">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700;900&family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --neon: #00ffaa; --bg: #050505; --text: #e5e7eb; --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.1); }
        body { font-family: 'Manrope', sans-serif; background-color: var(--bg); color: var(--text); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .font-brand { font-family: 'Unbounded', sans-serif; }
        .glass { background: var(--glass); backdrop-filter: blur(50px); border: 1px solid var(--border); }
        .btn-neon { background: var(--neon); color: #000; font-weight: 800; transition: 0.3s cubic-bezier(0.23, 1, 0.32, 1); border-radius: 20px; }
        .btn-neon:disabled { opacity: 0.5; cursor: not-allowed; }
        input, select, textarea { background: rgba(255,255,255,0.05) !important; border: 1px solid var(--border) !important; color: #fff !important; outline: none; border-radius: 20px !important; padding: 12px 18px !important; }
        .nav-item { transition: 0.4s; opacity: 0.4; cursor: pointer; color: var(--text); text-align: center; }
        .nav-item.active { opacity: 1; color: var(--neon); transform: translateY(-5px); }
        .logo-b { width: 40px; height: 40px; background: var(--neon); color: black; display: flex; align-items: center; justify-content: center; border-radius: 12px; font-family: 'Unbounded', sans-serif; font-weight: 900; font-size: 20px; box-shadow: 0 0 15px rgba(0, 255, 170, 0.3); cursor: pointer; }
        [v-cloak] { display: none; }
        .auth-code-box { font-size: clamp(2rem, 12vw, 4.5rem); font-weight: 900; letter-spacing: 4px; color: #fff; text-shadow: 0 0 20px var(--neon); background: rgba(255,255,255,0.03); border-radius: 24px; padding: 20px; width: 100%; text-align: center; font-family: 'Unbounded', sans-serif; }
    </style>
</head>
<body class="pb-36">

<div id="app" v-cloak>
    
    <!-- 1. AGE GATE -->
    <div v-if="!ageVerified" class="fixed inset-0 z-[2000] bg-[#050505] flex items-center justify-center p-8 text-center">
        <div class="animate__animated animate__zoomIn max-w-xs w-full">
            <div class="w-24 h-24 bg-[#00ffaa] rounded-3xl mx-auto mb-8 flex items-center justify-center text-black text-5xl font-black shadow-[0_0_40px_rgba(0,255,170,0.4)]">B</div>
            <h1 class="font-brand text-3xl mb-4 text-white italic tracking-tighter uppercase">–ë–∞—Ä–∞—Ö–æ–ª–∫–∞</h1>
            <p class="text-gray-500 text-sm mb-12">–í–∞–º –µ—Å—Ç—å 18 –ª–µ—Ç?</p>
            <button @click="verifyAge" class="btn-neon w-full py-6 text-sm tracking-widest uppercase font-black">–î–∞, –º–Ω–µ –µ—Å—Ç—å 18</button>
        </div>
    </div>

    <div v-else>
        
        <!-- Loading overlay -->
        <div v-if="loading" class="fixed inset-0 z-[1500] bg-black/80 backdrop-blur-md flex flex-col items-center justify-center">
            <div class="w-12 h-12 border-4 border-[#00ffaa]/20 border-t-[#00ffaa] rounded-full animate-spin mb-4"></div>
            <div class="text-[#00ffaa] font-brand italic text-[10px] tracking-[0.3em] uppercase">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>

        <!-- Toasts -->
        <div class="fixed top-6 right-6 z-[1600] space-y-3 max-w-[280px]">
            <transition-group name="animate__animated" enter-active-class="animate__fadeInRight" leave-active-class="animate__fadeOutRight">
                <div v-for="t in toasts" :key="t.id" class="glass px-6 py-4 rounded-3xl border-l-4 border-[#00ffaa] text-[11px] font-bold shadow-2xl">
                    {{ t.msg }}
                </div>
            </transition-group>
        </div>

        <!-- HEADER -->
        <header class="sticky top-0 z-50 glass border-b px-4 py-4">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <div @click="view = 'home'" class="flex items-center gap-3 cursor-pointer">
                    <div class="logo-b">B</div>
                    <span class="font-brand text-xl italic tracking-tighter">–ë–ê–†–ê–•–û–õ–ö–ê</span>
                </div>
                <div v-if="user" @click="view = 'profile'" class="w-10 h-10 rounded-xl overflow-hidden border border-[#00ffaa]/20">
                    <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-full h-full object-cover">
                </div>
                <button v-else @click="view = 'auth'" class="text-[#00ffaa] text-xs font-black uppercase">–í—Ö–æ–¥</button>
            </div>
        </header>

        <main class="max-w-6xl mx-auto px-4 pt-8">
            <transition name="animate__animated" enter-active-class="animate__fadeIn" mode="out-in">

                <!-- –í–ò–¢–†–ò–ù–ê -->
                <div v-if="view === 'home'" key="home">
                    <div class="mb-8 flex flex-col gap-4">
                        <div class="relative">
                            <input v-model="searchQuery" type="text" placeholder="–ü–æ–∏—Å–∫ (–¥–µ–≤–∞–π—Å, –≥–æ—Ä–æ–¥...)" class="w-full !pl-12 glass shadow-lg">
                            <span class="absolute left-4 top-1/2 -translate-y-1/2 opacity-30 text-lg">üîç</span>
                        </div>
                        <div class="flex gap-2">
                            <select v-model="filters.cat" class="glass flex-1 text-[10px] font-black uppercase py-4 px-4">
                                <option v-for="c in categories" :value="c">{{c}}</option>
                            </select>
                            <select v-model="sortBy" class="glass flex-1 text-[10px] font-black uppercase py-4 px-4">
                                <option value="new">–ù–æ–≤–∏–Ω–∫–∏</option>
                                <option value="cheap">–î–µ—à–µ–≤–ª–µ</option>
                                <option value="expensive">–î–æ—Ä–æ–∂–µ</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                        <div v-for="item in sortedItems" :key="item.id" @click="openItem(item)" class="glass rounded-[2.5rem] p-3 relative group cursor-pointer hover:scale-[1.02] transition-all hover:border-[#00ffaa]/50">
                            <button @click.stop="toggleFavorite(item.id)" class="absolute top-4 right-4 z-20 w-8 h-8 rounded-full glass flex items-center justify-center text-xs">
                                {{ isFavorite(item.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                            </button>
                            <button v-if="isAdmin" @click.stop="deleteItem(item.id)" class="absolute top-4 left-4 z-20 w-8 h-8 bg-red-600 rounded-full flex items-center justify-center text-white text-[10px]">‚úï</button>
                            <div class="aspect-square rounded-[1.5rem] overflow-hidden mb-3 bg-black/20">
                                <img :src="item.img" class="w-full h-full object-cover">
                            </div>
                            <h3 class="text-[12px] font-extrabold truncate uppercase px-1">{{item.title}}</h3>
                            <div class="flex justify-between items-center mt-1 px-1">
                                <span class="text-[#00ffaa] font-brand text-[10px]">{{item.price}} ‚ÇΩ</span>
                                <div class="flex gap-1">
                                    <span v-if="getUserCrown(item.user_id)">üëë</span>
                                    <span v-if="isUserVerified(item.user_id)">‚úÖ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ö–û–ú–ê–ù–î–ù–´–ô –¶–ï–ù–¢–† -->
                <div v-else-if="view === 'admin' && isAdmin" class="max-w-4xl mx-auto pb-10 px-2" key="admin">
                    <h2 class="font-brand text-2xl italic text-[#ff3366] mb-8 uppercase">–ú–∞—Å—Ç–µ—Ä-–¶–µ–Ω—Ç—Ä</h2>
                    <div class="grid grid-cols-1 gap-4">
                        <div v-for="u in dbUsers" :key="u.id" class="glass p-5 rounded-[2.5rem] flex flex-col md:flex-row items-center justify-between gap-5 border-l-4" :class="u.tg_id == MASTER_ADMIN_ID ? 'border-[#ff3366]' : 'border-transparent'">
                            <div class="flex items-center gap-5 w-full">
                                <img :src="u.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${u.name}`" class="w-16 h-16 rounded-2xl object-cover ring-2 ring-white/5">
                                <div class="flex-1">
                                    <div class="text-base font-black flex items-center gap-2">{{u.name}} <span v-if="u.has_crown">üëë</span><span v-if="u.is_verified">‚úÖ</span></div>
                                    <div class="text-[11px] opacity-40 uppercase">–í–∞—Ä–Ω—ã: {{u.strikes || 0}}/3</div>
                                    <div v-if="u.tg_id == MASTER_ADMIN_ID" class="text-[8px] text-[#ff3366] font-black uppercase mt-1">–û–°–ù–û–í–ê–¢–ï–õ–¨</div>
                                </div>
                            </div>
                            <div class="flex flex-wrap gap-2 w-full md:w-auto justify-center md:justify-end">
                                <template v-if="isCreator">
                                    <button @click="toggleCrown(u)" class="w-10 h-10 glass rounded-xl flex items-center justify-center text-lg">{{ u.has_crown ? 'üëë' : '‚ö™' }}</button>
                                    <button @click="toggleVerify(u)" class="w-10 h-10 glass rounded-xl flex items-center justify-center text-lg">{{ u.is_verified ? '‚úÖ' : '‚ö™' }}</button>
                                    <button v-if="u.tg_id != MASTER_ADMIN_ID" @click="toggleAdminRole(u)" class="px-4 py-2 glass rounded-xl text-[10px] font-black" :class="u.is_admin ? 'text-red-500' : 'text-blue-500'">{{ u.is_admin ? '–°–ù–Ø–¢–¨ –ê–î–ú' : '–î–ê–¢–¨ –ê–î–ú' }}</button>
                                </template>
                                <button @click="giveStrike(u)" v-if="u.tg_id != MASTER_ADMIN_ID" class="px-4 py-2 glass text-orange-500 text-[10px] font-black rounded-xl uppercase">–í–∞—Ä–Ω</button>
                                <button @click="removeStrike(u)" v-if="u.tg_id != MASTER_ADMIN_ID" class="w-10 h-10 glass text-green-500 rounded-xl flex items-center justify-center">‚Ü∫</button>
                                <button v-if="u.tg_id != user.tg_id && u.tg_id != MASTER_ADMIN_ID" @click="banUser(u)" class="px-4 py-2 bg-red-600/20 text-red-500 rounded-xl text-[10px] font-black uppercase">–ë–ê–ù</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü–†–û–§–ò–õ–¨ -->
                <div v-else-if="view === 'profile'" class="max-w-2xl mx-auto pb-10" key="profile">
                    <div v-if="isAdmin" @click="view = 'admin'" class="mb-6 p-6 rounded-[2.5rem] bg-[#ff3366] text-white text-center font-black text-xs uppercase shadow-xl cursor-pointer">
                        –£–ü–†–ê–í–õ–ï–ù–ò–ï –°–ï–†–í–ò–°–û–ú
                    </div>
                    <div class="glass p-8 rounded-[4rem] text-center border-t-8 border-[#00ffaa] shadow-2xl relative">
                        <div class="relative inline-block mb-8">
                            <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-40 h-40 rounded-[3.5rem] object-cover ring-4 ring-[#00ffaa]/20">
                            <label class="absolute -bottom-2 -right-2 w-12 h-12 bg-[#00ffaa] rounded-2xl flex items-center justify-center cursor-pointer shadow-xl border-4 border-[#050505]">
                                <span class="text-xl">üì∏</span>
                                <input type="file" @change="handleAvatarUpload" class="hidden">
                            </label>
                        </div>
                        <div v-if="!editingProfile" class="mb-8">
                            <h3 class="text-3xl font-black italic uppercase tracking-tighter flex items-center justify-center gap-3">{{user.name}} <span v-if="user.has_crown">üëë</span></h3>
                            <button @click="editingProfile = true" class="text-[#00ffaa] text-[10px] font-bold uppercase mt-4">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
                        </div>
                        <div v-else class="mb-8 space-y-4 max-w-xs mx-auto">
                            <input v-model="editName" type="text" class="w-full text-center text-sm font-bold glass">
                            <div class="flex gap-2">
                                <button @click="updateProfile" class="btn-neon flex-1 py-4 text-[10px]">–û–ö</button>
                                <button @click="editingProfile = false" class="glass flex-1 py-4 text-[10px]">–ù–ï–¢</button>
                            </div>
                        </div>
                        <div class="flex justify-center gap-4 mb-8">
                            <button @click="profileTab = 'my'" :class="profileTab === 'my' ? 'bg-[#00ffaa] text-black shadow-lg' : 'glass text-gray-400'" class="px-6 py-3 rounded-2xl text-[10px] font-black uppercase transition-all">–ú–æ–∏ –ª–æ—Ç—ã</button>
                            <button @click="profileTab = 'fav'" :class="profileTab === 'fav' ? 'bg-pink-500 text-white shadow-lg' : 'glass text-gray-400'" class="px-6 py-3 rounded-2xl text-[10px] font-black uppercase transition-all">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ ‚ù§Ô∏è</button>
                        </div>
                        <button @click="logout" class="text-red-500 font-black uppercase text-[10px]">–í—ã–π—Ç–∏</button>
                    </div>
                    <div class="mt-12 space-y-4">
                        <div v-if="profileTab === 'my'" class="space-y-4">
                            <div v-for="item in myItems" :key="item.id" class="glass p-5 rounded-[2.5rem] flex items-center justify-between">
                                <div class="flex items-center gap-6">
                                    <img :src="item.img" class="w-16 h-16 rounded-2xl object-cover shadow-xl">
                                    <h4 class="text-sm font-extrabold uppercase truncate w-32">{{item.title}}</h4>
                                </div>
                                <button @click="deleteItem(item.id)" class="text-red-500 font-black text-xs px-4">–£–î–ê–õ–ò–¢–¨</button>
                            </div>
                        </div>
                        <div v-else class="grid grid-cols-2 gap-4">
                            <div v-for="item in favoriteItems" :key="item.id" @click="openItem(item)" class="glass p-3 rounded-[2rem] text-center relative">
                                <img :src="item.img" class="w-full aspect-square rounded-2xl object-cover mb-2">
                                <button @click.stop="toggleFavorite(item.id)" class="mt-2 text-red-500 text-[10px] font-black uppercase">–£–ë–†–ê–¢–¨ ‚ù§Ô∏è</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –î–û–ë–ê–í–õ–ï–ù–ò–ï (–° –§–ò–ö–°–û–ú –í–ï–°–ê –§–û–¢–û) -->
                <div v-else-if="view === 'add'" class="max-w-xl mx-auto pb-10" key="add">
                    <div class="glass p-8 rounded-[4.5rem] shadow-2xl border-t-8 border-[#00ffaa]">
                        <h2 class="font-brand text-2xl mb-12 italic text-center uppercase">–í—ã—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</h2>
                        <div class="space-y-6">
                            <div @click="$refs.fileInput.click()" class="h-72 glass rounded-[3.5rem] border-2 border-dashed border-white/10 flex flex-col items-center justify-center cursor-pointer overflow-hidden group">
                                <img v-if="newItem.img" :src="newItem.img" class="w-full h-full object-cover">
                                <div v-else class="text-center opacity-30"><span class="text-5xl mb-4 block">üì∏</span><span class="text-[10px] font-black uppercase">–í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ</span></div>
                                <input type="file" ref="fileInput" @change="handleFileUpload" class="hidden" accept="image/*">
                            </div>
                            <input v-model="newItem.title" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
                            <div class="grid grid-cols-2 gap-5">
                                <select v-model="newItem.category" class="glass font-bold text-xs"><option v-for="c in categories.slice(1)" :value="c">{{c}}</option></select>
                                <input v-model.number="newItem.price" type="number" placeholder="–¶–µ–Ω–∞ ‚ÇΩ">
                            </div>
                            <input v-model="newItem.city" type="text" placeholder="–¢–≤–æ–π –≥–æ—Ä–æ–¥">
                            <input v-model="newItem.tg_user" type="text" placeholder="–ù–∏–∫ –≤ Telegram –±–µ–∑ @">
                            <textarea v-model="newItem.desc_text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..." class="h-44"></textarea>
                            <button @click="createListing" :disabled="publishing" class="btn-neon w-full py-7 text-xs font-black uppercase shadow-xl">
                                {{ publishing ? '–ü–£–ë–õ–ò–ö–ê–¶–ò–Ø...' : '–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨' }}
                            </button>
                        </div>
                    </div>
                </div>

                <!-- –í–•–û–î -->
                <div v-else-if="view === 'auth'" class="max-w-md mx-auto py-20 text-center px-4" key="auth">
                    <div class="glass p-14 rounded-[5rem] border-b-8 border-sky-500 shadow-2xl">
                        <h2 class="font-brand text-3xl mb-8 uppercase italic">–í—Ö–æ–¥</h2>
                        <div v-if="authStep === 'input'" class="space-y-8">
                            <input v-model="auth.name" type="text" placeholder="–ù–∏–∫ –¥–ª—è —Å–∞–π—Ç–∞" class="w-full text-center text-sm font-bold glass">
                            <button @click="startAuth" class="btn-neon w-full py-7 rounded-[3rem] text-xs font-black">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
                        </div>
                        <div v-else class="space-y-10">
                            <div class="auth-code-box shadow-xl">{{verifyCode}}</div>
                            <p class="text-[10px] text-gray-500 font-black uppercase">–û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É –∫–æ–¥: <br> <span class="text-sky-400">@your_vape_bot</span></p>
                            <a href="https://t.me/your_vape_bot" target="_blank" class="block w-full py-7 rounded-[3rem] bg-sky-600 text-white font-black text-xs shadow-2xl uppercase">–í Telegram</a>
                        </div>
                    </div>
                </div>

            </transition>
        </main>

        <!-- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ -->
        <nav class="fixed bottom-8 inset-x-8 glass px-10 py-6 flex justify-between rounded-[3.5rem] max-w-lg mx-auto shadow-[0_20px_60px_rgba(0,0,0,0.6)] backdrop-blur-3xl border border-white/10 z-[100]">
            <button @click="view = 'home'" :class="{active: view === 'home'}" class="nav-item flex flex-col items-center gap-1">
                <span class="text-2xl">üè†</span>
                <span class="text-[9px] font-black uppercase tracking-widest">–í–∏—Ç—Ä–∏–Ω–∞</span>
            </button>
            <button @click="user ? view = 'add' : view = 'auth'" :class="{active: view === 'add'}" class="nav-item flex flex-col items-center gap-1">
                <span class="text-2xl">‚ûï</span>
                <span class="text-[9px] font-black uppercase tracking-widest">–ü—Ä–æ–¥–∞—Ç—å</span>
            </button>
            <button @click="user ? (view = 'profile' || view === 'admin') : view = 'auth'" :class="{active: view === 'profile' || view === 'admin'}" class="nav-item flex flex-col items-center gap-1">
                <span class="text-2xl">üë§</span>
                <span class="text-[9px] font-black uppercase tracking-widest">–ü—Ä–æ—Ñ–∏–ª—å</span>
            </button>
        </nav>
    </div>
</div>

<script>
const { createApp } = Vue;

const SUPABASE_URL = 'https://gcxnstwsqkmdotqblkfd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeG5zdHdzcWttZG90cWJsa2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDI3MzIsImV4cCI6MjA4MjM3ODczMn0.79gdNrKNRcdPTbban-6uK3GP5Czyq-II7kRHaRyfvqE';

const MASTER_ADMIN_ID = 1735153058; // –°–û–ó–î–ê–¢–ï–õ–¨
const BOT_TOKEN = '7688454041:AAFFBc0Ye7RRq0RFuSst_QfTqQ0TpQu9aWI';

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

createApp({
    data() {
        return {
            LOGO_URL: 'https://i.postimg.cc/mD8370vC/walter.jpg', theme: 'dark',
            ageVerified: localStorage.getItem('vb_age_v33') === 'true',
            loading: true, view: 'home', profileTab: 'my',
            user: JSON.parse(localStorage.getItem('vb_cloud_v33')) || null,
            favorites: JSON.parse(localStorage.getItem('vb_favs_v33')) || [],
            items: [], dbUsers: [], categories: ['–í—Å–µ', '–ü–æ–¥—ã', '–ú–æ–¥—ã', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ó–∞–ø—á–∞—Å—Ç–∏', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'],
            filters: { cat: '–í—Å–µ' }, searchQuery: '', sortBy: 'new',
            auth: { name: '' }, authStep: 'input', verifyCode: '',
            newItem: { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '' },
            selectedItem: null, contactRevealed: false, editingProfile: false, editName: '', toasts: [],
            publishing: false, strikeNoticeClosed: false, MASTER_ADMIN_ID: MASTER_ADMIN_ID
        }
    },
    computed: {
        isCreator() { return this.user && this.user.tg_id == MASTER_ADMIN_ID; },
        isAdmin() { return this.user && (this.user.is_admin || this.isCreator); },
        sortedItems() {
            let filtered = this.items.filter(i => {
                const matchCat = this.filters.cat === '–í—Å–µ' || i.category === this.filters.cat;
                const q = this.searchQuery.toLowerCase();
                return matchCat && (i.title.toLowerCase().includes(q) || i.city.toLowerCase().includes(q));
            });
            if (this.sortBy === 'cheap') return filtered.sort((a, b) => a.price - b.price);
            if (this.sortBy === 'expensive') return filtered.sort((a, b) => b.price - a.price);
            return filtered.sort((a, b) => b.id - a.id);
        },
        myItems() { return this.user ? this.items.filter(i => i.user_id === this.user.id) : []; },
        favoriteItems() { return this.items.filter(i => this.favorites.includes(i.id)); }
    },
    async mounted() {
        if (this.ageVerified) await this.initApp();
        else this.loading = false;
        if (this.user) this.editName = this.user.name;
        client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, () => this.fetchData()).subscribe();
        client.channel('any_users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => this.fetchData()).subscribe();
    },
    methods: {
        async initApp() { this.loading = true; await this.fetchData(); this.loading = false; },
        notify(msg) {
            const id = Date.now();
            this.toasts.push({ id, msg });
            setTimeout(() => this.toasts = this.toasts.filter(t => t.id !== id), 3000);
        },
        async verifyAge() { this.ageVerified = true; localStorage.setItem('vb_age_v33', 'true'); await this.initApp(); },
        async fetchData() {
            const { data: items } = await client.from('items').select('*').order('id', { ascending: false });
            const { data: users } = await client.from('users').select('*').order('id', { ascending: true });
            this.items = items || []; this.dbUsers = users || [];
            if (this.user) {
                const updated = this.dbUsers.find(u => u.tg_id == this.user.tg_id);
                if (updated) { 
                    this.user = updated; 
                    if (this.isCreator && updated.strikes > 0) await client.from('users').update({ strikes: 0 }).eq('tg_id', MASTER_ADMIN_ID);
                    localStorage.setItem('vb_cloud_v33', JSON.stringify(this.user)); 
                    if (updated.is_banned) { this.logout(); this.notify('–î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç ‚ùå'); }
                }
            }
        },
        toggleFavorite(id) {
            const idx = this.favorites.indexOf(id);
            if (idx > -1) this.favorites.splice(idx, 1);
            else this.favorites.push(id);
            localStorage.setItem('vb_favs_v33', JSON.stringify(this.favorites));
            this.notify(idx > -1 ? '–£–¥–∞–ª–µ–Ω–æ' : '–í –∏–∑–±—Ä–∞–Ω–Ω–æ–º ‚ù§Ô∏è');
        },
        isFavorite(id) { return this.favorites.includes(id); },
        async updateProfile() {
            if (!this.editName) return;
            await client.from('users').update({ name: this.editName }).eq('id', this.user.id);
            this.editingProfile = false; this.notify('–ù–∏–∫ –æ–±–Ω–æ–≤–ª–µ–Ω! ‚ú®'); await this.fetchData();
        },
        async startAuth() {
            this.verifyCode = Math.floor(1000 + Math.random() * 9000).toString(); this.authStep = 'telegram';
            const interval = setInterval(async () => {
                if(this.view !== 'auth') return clearInterval(interval);
                const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates`);
                const data = await res.json();
                const found = data.result.reverse().find(u => u.message && u.message.text === this.verifyCode);
                if (found) { clearInterval(interval); await this.finalizeAuth(found.message.from); }
            }, 3000);
        },
        async finalizeAuth(tg) {
            let { data: existingUser } = await client.from('users').select('*').eq('tg_id', tg.id).single();
            if (!existingUser) {
                const { data: newUser } = await client.from('users').insert([{ tg_id: tg.id, name: this.auth.name, tg_name: tg.username || tg.first_name, is_admin: tg.id == MASTER_ADMIN_ID, role: tg.id == MASTER_ADMIN_ID ? 'owner' : 'user' }]).select().single();
                existingUser = newUser;
            }
            this.user = existingUser; localStorage.setItem('vb_cloud_v33', JSON.stringify(this.user));
            this.view = 'home'; this.editName = this.user.name; await this.fetchData();
        },
        async handleAvatarUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            this.loading = true;
            const reader = new FileReader();
            reader.onload = async (f) => {
                // –°–∂–∞—Ç–∏–µ –∞–≤–∞—Ç–∞—Ä–∫–∏ –¥–æ 400px
                const compressed = await this.compressImage(f.target.result, 400);
                await client.from('users').update({ avatar: compressed }).eq('id', this.user.id);
                this.user.avatar = compressed;
                localStorage.setItem('vb_cloud_v33', JSON.stringify(this.user));
                this.loading = false;
                this.notify('–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!'); await this.fetchData();
            };
            reader.readAsDataURL(file);
        },
        compressImage(base64, maxWidth) {
            return new Promise((resolve) => {
                const img = new Image();
                img.src = base64;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7)); // –ö–∞—á–µ—Å—Ç–≤–æ 70%
                };
            });
        },
        async handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (f) => {
                // –°–∂–∏–º–∞–µ–º –¥–æ 800px –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –≤ —Ñ–æ—Ä–º–µ
                this.newItem.img = await this.compressImage(f.target.result, 800);
            };
            reader.readAsDataURL(file);
        },
        async createListing() {
            if (!this.newItem.img || !this.newItem.title || !this.newItem.price) return this.notify('–ó–∞–ø–æ–ª–Ω–∏ –≤—Å—ë!');
            this.publishing = true;
            const { error } = await client.from('items').insert([{
                title: this.newItem.title, category: this.newItem.category, price: this.newItem.price,
                city: this.newItem.city, desc_text: this.newItem.desc_text, tg_user: this.newItem.tg_user,
                img: this.newItem.img, user_id: this.user.id, seller_name: this.user.name
            }]);
            this.publishing = false;
            if (error) return this.notify('–û—à–∏–±–∫–∞ –±–∞–∑—ã!');
            this.view = 'home'; this.newItem = { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '' };
            this.notify('–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ! üöÄ');
        },
        async deleteItem(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { this.items = this.items.filter(i => i.id !== id); await client.from('items').delete().eq('id', id); } },
        async toggleAdminRole(u) { await client.from('users').update({ is_admin: !u.is_admin }).eq('id', u.id); this.notify('–†–æ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∞'); },
        async toggleVerify(u) { await client.from('users').update({ is_verified: !u.is_verified }).eq('id', u.id); this.notify('–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω'); },
        async toggleCrown(u) { await client.from('users').update({ has_crown: !u.has_crown }).eq('id', u.id); this.notify('–ö–æ—Ä–æ–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∞'); },
        async giveStrike(u) {
            const r = prompt('–ü—Ä–∏—á–∏–Ω–∞:'); if(!r) return;
            let strikes = (u.strikes || 0) + 1;
            await client.from('users').update({ strikes, strike_reason: r, is_banned: strikes >= 3 }).eq('id', u.id);
            this.notify('–í–∞—Ä–Ω –≤—ã–¥–∞–Ω');
        },
        async removeStrike(u) { await client.from('users').update({ strikes: 0, strike_reason: '' }).eq('id', u.id); this.notify('–°–Ω—è—Ç–æ'); },
        async banUser(u) { await client.from('users').update({ is_banned: !u.is_banned, strikes: 0 }).eq('id', u.id); this.notify('–ë–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω'); },
        openItem(item) { this.selectedItem = item; this.view = 'product'; window.scrollTo(0,0); },
        contactSeller() { window.open(`https://t.me/${this.selectedItem.tg_user.replace('@', '')}`, '_blank'); },
        getSellerAvatar(userId) { const s = this.dbUsers.find(u => u.id === userId); return s?.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${userId}`; },
        isUserVerified(userId) { return this.dbUsers.find(x => x.id === userId)?.is_verified; },
        getUserCrown(userId) { return this.dbUsers.find(x => x.id === userId)?.has_crown; },
        logout() { this.user = null; localStorage.removeItem('vb_cloud_v33'); this.view = 'home'; }
    }
}).mount('#app')
</script>
</body>
</html>
