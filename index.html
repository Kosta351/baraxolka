<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bazar Pro | Police Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Manrope:wght@400;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --accent: #00ffaa; --bg: #030303; --card: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08); }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); color: #fff; overflow-x: hidden; background-image: radial-gradient(circle at 50% -20%, #00ffaa15, transparent); }
        .font-brand { font-family: 'Unbounded', sans-serif; }
        .glass { background: var(--card); backdrop-filter: blur(25px); border: 1px solid var(--border); }
        .btn-prime { background: linear-gradient(135deg, var(--accent), #00d4ff); color: #000; font-weight: 800; transition: 0.3s; border-radius: 1.2rem; }
        .tab-bar-item { opacity: 0.4; transition: 0.4s; cursor: pointer; }
        .tab-bar-item.active { opacity: 1; color: var(--accent); }
        [v-cloak] { display: none; }
        
        /* –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤–∞—Ä–Ω–∞ */
        .strike-modal { background: rgba(10, 0, 0, 0.95); backdrop-filter: blur(20px); border: 2px solid #ff3366; box-shadow: 0 0 50px rgba(255, 51, 102, 0.3); }
        .strike-card { border-left: 4px solid #ff3366; background: rgba(255, 51, 102, 0.05); }
    </style>
</head>
<body class="pb-32">

<div id="app" v-cloak>
    
    <!-- 1. AGE GATE -->
    <div v-if="!ageVerified" class="fixed inset-0 z-[5000] bg-[#030303] flex items-center justify-center p-8 text-center">
        <div class="animate__animated animate__fadeInUp">
            <div class="w-20 h-20 bg-[#00ffaa] rounded-[2rem] mx-auto mb-8 flex items-center justify-center text-black text-4xl font-black shadow-[0_0_50px_rgba(0,255,170,0.5)]">B</div>
            <button @click="verifyAge" class="btn-prime w-full py-6 px-12 uppercase text-[10px]">–ú–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç</button>
        </div>
    </div>

    <div v-else>
        
        <!-- üì¢ –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –û –í–ê–†–ù–ï (–î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø) -->
        <div v-if="user && user.strikes > 0 && !strikeNoticeClosed" class="fixed inset-0 z-[6000] flex items-center justify-center p-6 text-center">
            <div class="strike-modal p-10 rounded-[3.5rem] max-w-sm w-full animate__animated animate__shakeX">
                <div class="text-6xl mb-6">‚ö†Ô∏è</div>
                <h2 class="font-brand text-xl text-[#ff3366] uppercase mb-2">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ</h2>
                <p class="text-[10px] uppercase font-black opacity-50 mb-8 tracking-[0.2em]">–ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª —Å–æ–æ–±—â–µ—Å—Ç–≤–∞</p>
                
                <div class="bg-white/5 p-6 rounded-3xl mb-10 text-left">
                    <div class="text-[8px] font-black text-[#ff3366] uppercase mb-2">–ü—Ä–∏—á–∏–Ω–∞:</div>
                    <div class="text-sm italic text-gray-200">"{{ user.strike_reason || '–ù–∞—Ä—É—à–µ–Ω–∏–µ –æ–±—â–∏—Ö –ø—Ä–∞–≤–∏–ª –ø–ª–æ—â–∞–¥–∫–∏' }}"</div>
                    <div class="mt-6 flex justify-between items-center">
                        <span class="text-[9px] uppercase font-bold opacity-40">–°—Ç–∞—Ç—É—Å:</span>
                        <span class="text-xs font-brand text-[#ff3366]">{{ user.strikes }} / 3</span>
                    </div>
                </div>

                <button @click="strikeNoticeClosed = true" class="w-full py-5 glass rounded-2xl text-[10px] font-black uppercase hover:bg-white/5 transition-all">–Ø –≤—Å—ë –ø–æ–Ω—è–ª</button>
                <p class="mt-4 text-[7px] opacity-20 uppercase font-black">–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ 3-—Ö –≤–∞—Ä–Ω–æ–≤ –∞–∫–∫–∞—É–Ω—Ç –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –Ω–∞–≤—Å–µ–≥–¥–∞</p>
            </div>
        </div>

        <!-- –•–ï–î–ï–† -->
        <header class="p-6 pb-2 flex justify-between items-center">
            <div @click="view = 'home'" class="cursor-pointer">
                <h1 class="font-brand text-2xl font-black italic tracking-tighter">BAZAR<span class="text-[#00ffaa]">.</span></h1>
                <div class="flex items-center gap-2 mt-1">
                    <span class="text-[9px] font-bold opacity-30 uppercase tracking-widest">{{ items.length }} –ª–æ—Ç–æ–≤</span>
                </div>
            </div>
            <div v-if="user" @click="view = 'profile'" class="w-12 h-12 rounded-2xl glass p-1 cursor-pointer overflow-hidden">
                <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-full h-full object-cover rounded-xl">
            </div>
            <button v-else @click="view = 'auth'" class="btn-prime px-6 py-2 text-[10px] uppercase">–í—Ö–æ–¥</button>
        </header>

        <main class="px-6 pb-40">
            <transition name="animate__animated" enter-active-class="animate__fadeInUp animate__faster" mode="out-in">

                <!-- –í–ò–¢–†–ò–ù–ê -->
                <div v-if="view === 'home'" key="home">
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div v-for="item in sortedItems" :key="item.id" @click="openItem(item)" class="glass rounded-[2.2rem] p-3 relative hover:translate-y-[-5px] transition-all group">
                            <div class="aspect-square rounded-[1.6rem] overflow-hidden mb-3 bg-black/40 relative">
                                <img :src="item.img" class="w-full h-full object-cover">
                                <div v-if="userMap[item.user_id]?.strikes > 0" class="absolute top-2 left-2 bg-red-500 text-white text-[7px] px-2 py-1 rounded font-black uppercase">Warned</div>
                            </div>
                            <h3 class="text-[10px] font-black uppercase truncate mb-1 px-1">{{item.title}}</h3>
                            <div class="text-[#00ffaa] font-brand text-[12px] px-1">{{item.price}} ‚ÇΩ</div>
                        </div>
                    </div>
                </div>

                <!-- –ê–î–ú–ò–ù–ö–ê (–° –í–ê–†–ù–ê–ú–ò) -->
                <div v-else-if="view === 'admin' && isAdmin" key="admin" class="space-y-4">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-brand text-xl text-[#ff3366] uppercase italic">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                        <button @click="view = 'profile'" class="text-[10px] glass px-4 py-2 rounded-xl">–ù–∞–∑–∞–¥</button>
                    </div>
                    <div v-for="u in dbUsers" :key="u.id" class="glass p-5 rounded-[2.5rem] flex flex-col gap-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <img :src="u.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${u.name}`" class="w-12 h-12 rounded-xl object-cover">
                                <div>
                                    <div class="text-[11px] font-black uppercase">{{u.name}}</div>
                                    <div :class="u.strikes > 0 ? 'text-red-500' : 'opacity-30'" class="text-[8px] font-black uppercase mt-1">
                                        –í–∞—Ä–Ω—ã: {{u.strikes || 0}} / 3
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="toggleCrown(u)" class="w-10 h-10 glass rounded-xl flex items-center justify-center">{{ u.has_crown ? 'üëë' : '‚ö™' }}</button>
                                <button @click="toggleVerify(u)" class="w-10 h-10 glass rounded-xl flex items-center justify-center">{{ u.is_verified ? '‚úÖ' : '‚ö™' }}</button>
                            </div>
                        </div>
                        
                        <!-- –ö–Ω–æ–ø–∫–∏ –ú–æ–¥–µ—Ä–∞—Ü–∏–∏ -->
                        <div class="flex gap-2 border-t border-white/5 pt-4">
                            <button @click="giveStrike(u)" class="flex-1 py-3 bg-orange-500/10 text-orange-500 text-[9px] font-black rounded-xl uppercase hover:bg-orange-500/20 transition-all">‚ö†Ô∏è –í—ã–¥–∞—Ç—å –≤–∞—Ä–Ω</button>
                            <button @click="removeStrikes(u)" class="p-3 glass rounded-xl text-green-500">‚Ü∫</button>
                            <button @click="banUser(u)" class="flex-1 py-3 bg-red-500/10 text-red-500 text-[9px] font-black rounded-xl uppercase">{{ u.is_banned ? '–†–∞–∑–±–∞–Ω–∏—Ç—å' : '–ë–∞–Ω' }}</button>
                        </div>
                    </div>
                </div>

                <!-- –ü–†–û–§–ò–õ–¨ -->
                <div v-else-if="view === 'profile' && user" key="profile" class="space-y-6">
                    <div v-if="isAdmin" @click="view = 'admin'" class="p-4 rounded-3xl bg-[#ff3366] text-white text-center font-black text-[10px] uppercase cursor-pointer">–ê–¥–º–∏–Ω–∫–∞ üõ†Ô∏è</div>
                    <div class="glass p-10 rounded-[3.5rem] text-center relative overflow-hidden">
                        <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-24 h-24 rounded-[2rem] mx-auto mb-6 object-cover ring-4 ring-[#00ffaa]/10">
                        <h2 class="font-brand text-xl uppercase italic">{{user.name}}</h2>
                        <div v-if="user.strikes > 0" class="mt-4 inline-block px-4 py-1 bg-red-500/20 text-red-500 text-[8px] font-black uppercase rounded-full">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π: {{user.strikes}}</div>
                        <button @click="logout" class="block w-full mt-10 text-red-500 text-[10px] uppercase font-black opacity-40">–í—ã—Ö–æ–¥</button>
                    </div>
                </div>

                <!-- –í–•–û–î -->
                <div v-else-if="view === 'auth'" key="auth" class="max-w-md mx-auto py-10">
                    <div class="glass p-12 rounded-[3.5rem] text-center">
                        <h2 class="font-brand text-3xl uppercase mb-10 italic">–í—Ö–æ–¥</h2>
                        <input v-model="auth.name" type="text" placeholder="–¢–≤–æ–π –Ω–∏–∫" class="w-full p-5 glass rounded-2xl mb-4 text-center text-white font-bold">
                        <button @click="startAuth" class="btn-prime w-full py-6 text-[10px] uppercase">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
                        <div v-if="verifyCode" class="mt-8">
                            <div class="text-4xl font-brand text-[#00ffaa] mb-2">{{verifyCode}}</div>
                            <p class="text-[9px] opacity-40 uppercase">–ù–∞–ø–∏—à–∏ –∫–æ–¥ –±–æ—Ç—É: @your_vape_bot</p>
                        </div>
                    </div>
                </div>

            </transition>
        </main>

        <!-- –¢–ê–ë-–ë–ê–† -->
        <nav class="fixed bottom-8 inset-x-8 z-[100] max-w-sm mx-auto">
            <div class="glass rounded-[2.5rem] p-3 flex justify-around items-center shadow-2xl">
                <button @click="view = 'home'" :class="['tab-bar-item p-3', {active: view === 'home'}]">üè†</button>
                <button @click="user ? view = 'add' : view = 'auth'" :class="['tab-bar-item p-3', {active: view === 'add'}]">‚ûï</button>
                <button @click="user ? (view = 'profile' || view === 'admin') : view = 'auth'" :class="['tab-bar-item p-3', {active: view === 'profile' || view === 'admin'}]">üë§</button>
            </div>
        </nav>
    </div>
</div>

<script>
const { createApp } = Vue;

const SUPABASE_URL = 'https://gcxnstwsqkmdotqblkfd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeG5zdHdzcWttZG90cWJsa2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDI3MzIsImV4cCI6MjA4MjM3ODczMn0.79gdNrKNRcdPTbban-6uK3GP5Czyq-II7kRHaRyfvqE';
const BOT_TOKEN = '7688454041:AAFFBc0Ye7RRq0RFuSst_QfTqQ0TpQu9aWI';
const MASTER_ADMIN_ID = 1735153058;

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

createApp({
    data() {
        return {
            ageVerified: localStorage.getItem('vape_age_v10') === 'true',
            loading: true, view: 'home',
            user: JSON.parse(localStorage.getItem('vape_user_v10')) || null,
            items: [], dbUsers: [], userMap: {},
            categories: ['–í—Å–µ', '–ü–æ–¥—ã', '–ú–æ–¥—ã', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ó–∞–ø—á–∞—Å—Ç–∏'],
            filters: { cat: '–í—Å–µ' }, searchQuery: '',
            auth: { name: '' }, verifyCode: '',
            newItem: { title: '', price: null, city: '', img: '' },
            strikeNoticeClosed: false,
            publishing: false
        }
    },
    computed: {
        isAdmin() { return this.user && (this.user.is_admin || this.user.tg_id == MASTER_ADMIN_ID); },
        sortedItems() {
            return this.items.filter(i => i.title.toLowerCase().includes(this.searchQuery.toLowerCase()));
        }
    },
    async mounted() {
        if (this.ageVerified) await this.fetchData();
        else this.loading = false;
        
        client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => this.fetchData()).subscribe();
        client.channel('any_items').on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, () => this.fetchData()).subscribe();
    },
    methods: {
        async fetchData() {
            try {
                const { data: it } = await client.from('items').select('*').order('id', {ascending: false});
                const { data: us } = await client.from('users').select('*');
                this.items = it || [];
                this.dbUsers = us || [];
                const map = {};
                this.dbUsers.forEach(u => map[u.id] = u);
                this.userMap = map;

                if (this.user) {
                    const fresh = this.dbUsers.find(u => u.id === this.user.id);
                    if (fresh) {
                        this.user = fresh;
                        localStorage.setItem('vape_user_v10', JSON.stringify(this.user));
                        if (fresh.is_banned) this.logout();
                    }
                }
            } catch (e) { console.error(e) }
            finally { this.loading = false }
        },
        verifyAge() { this.ageVerified = true; localStorage.setItem('vape_age_v10', 'true'); this.fetchData(); },
        
        // --- ADMIN METHODS FOR STRIKES ---
        async giveStrike(u) {
            const reason = prompt(`–í–≤–µ–¥–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –≤–∞—Ä–Ω–∞ –¥–ª—è ${u.name}:`);
            if (!reason) return;
            const newStrikes = (u.strikes || 0) + 1;
            const isBanned = newStrikes >= 3;
            
            await client.from('users').update({ 
                strikes: newStrikes, 
                strike_reason: reason,
                is_banned: isBanned
            }).eq('id', u.id);
            
            alert(`–í–∞—Ä–Ω –≤—ã–¥–∞–Ω! –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: ${newStrikes}/3`);
            await this.fetchData();
        },
        async removeStrikes(u) {
            if (confirm(`–û–±–Ω—É–ª–∏—Ç—å –≤–∞—Ä–Ω—ã –¥–ª—è ${u.name}?`)) {
                await client.from('users').update({ strikes: 0, strike_reason: '', is_banned: false }).eq('id', u.id);
                await this.fetchData();
            }
        },
        async banUser(u) {
            await client.from('users').update({ is_banned: !u.is_banned }).eq('id', u.id);
            await this.fetchData();
        },
        async toggleCrown(u) { await client.from('users').update({ has_crown: !u.has_crown }).eq('id', u.id); await this.fetchData(); },
        async toggleVerify(u) { await client.from('users').update({ is_verified: !u.is_verified }).eq('id', u.id); await this.fetchData(); },

        // --- AUTH & OTHER ---
        async startAuth() {
            this.verifyCode = Math.floor(1000 + Math.random() * 9000).toString();
            const poll = setInterval(async () => {
                const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-1`);
                const data = await res.json();
                const msg = data.result.find(u => u.message && u.message.text === this.verifyCode);
                if (msg) { clearInterval(poll); this.finalizeAuth(msg.message.from); }
            }, 3000);
        },
        async finalizeAuth(tg) {
            let { data: user } = await client.from('users').select('*').eq('tg_id', tg.id).single();
            if (!user) {
                const { data: newUser } = await client.from('users').insert([{ tg_id: tg.id, name: this.auth.name, is_admin: tg.id == MASTER_ADMIN_ID }]).select().single();
                user = newUser;
            }
            this.user = user;
            localStorage.setItem('vape_user_v10', JSON.stringify(this.user));
            this.view = 'home'; await this.fetchData();
        },
        logout() { this.user = null; localStorage.removeItem('vape_user_v10'); this.view = 'home'; }
    }
}).mount('#app')
</script>
</body>
</html>
