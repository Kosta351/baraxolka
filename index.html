<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ë–∞—Ä–∞—Ö–æ–ª–∫–∞ Pro | Admin Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;700;900&family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --neon: #00ffaa; --bg: #050505; --text: #e5e7eb; --glass: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.1); --admin: #ff3366; }
        body { font-family: 'Manrope', sans-serif; background-color: var(--bg); color: var(--text); overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .font-brand { font-family: 'Unbounded', sans-serif; }
        .glass { background: var(--glass); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid var(--border); }
        .btn-neon { background: var(--neon); color: #000; font-weight: 800; transition: 0.3s; border-radius: 1.5rem; }
        .btn-neon:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0, 255, 170, 0.4); }
        .admin-card { border-left: 4px solid var(--admin); background: rgba(255, 51, 102, 0.02); }
        [v-cloak] { display: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 10px; }
    </style>
</head>
<body class="pb-32">

<div id="app" v-cloak>
    
    <!-- 1. AGE GATE -->
    <div v-if="!ageVerified" class="fixed inset-0 z-[3000] bg-[#050505] flex items-center justify-center p-8 text-center">
        <div class="animate__animated animate__zoomIn max-w-xs">
            <div class="w-20 h-20 bg-[#00ffaa] rounded-3xl mx-auto mb-8 flex items-center justify-center text-black text-4xl font-black shadow-[0_0_40px_rgba(0,255,170,0.3)]">B</div>
            <h1 class="font-brand text-2xl mb-4 uppercase italic">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤–æ–∑—Ä–∞—Å—Ç</h1>
            <p class="text-gray-500 text-sm mb-10">–í–∞–º –µ—Å—Ç—å 18 –ª–µ—Ç?</p>
            <button @click="verifyAge" class="btn-neon w-full py-5 text-xs uppercase font-black">–î–∞, –º–Ω–µ –µ—Å—Ç—å 18</button>
        </div>
    </div>

    <div v-else>
        <!-- –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div v-if="loading" class="fixed top-0 left-0 w-full h-1 bg-[#00ffaa]/20 z-[4000]">
            <div class="h-full bg-[#00ffaa] animate-pulse w-full"></div>
        </div>

        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div class="fixed top-6 right-6 z-[3500] space-y-3">
            <transition-group name="animate__animated" enter-active-class="animate__fadeInRight" leave-active-class="animate__fadeOutRight">
                <div v-for="t in toasts" :key="t.id" class="glass px-6 py-4 rounded-2xl border-l-4 border-[#00ffaa] text-[10px] font-bold shadow-2xl">
                    {{ t.msg }}
                </div>
            </transition-group>
        </div>

        <!-- –®–ê–ü–ö–ê -->
        <header class="sticky top-0 z-50 glass border-b px-4 py-4">
            <div class="max-w-6xl mx-auto flex justify-between items-center">
                <div @click="view = 'home'" class="flex items-center gap-3 cursor-pointer">
                    <div class="w-10 h-10 bg-[#00ffaa] text-black rounded-xl flex items-center justify-center font-brand font-black">B</div>
                    <span class="font-brand text-xl italic uppercase tracking-tighter">–ë–ê–†–ê–•–û–õ–ö–ê</span>
                </div>
                <div v-if="user" @click="view = 'profile'" class="cursor-pointer flex items-center gap-3 glass p-1 pr-4 rounded-full">
                    <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-8 h-8 rounded-full object-cover">
                    <span class="text-[10px] font-black uppercase tracking-widest">{{user.name}}</span>
                </div>
                <button v-else @click="view = 'auth'" class="text-[#00ffaa] text-[10px] font-black uppercase">–í—Ö–æ–¥</button>
            </div>
        </header>

        <main class="max-w-6xl mx-auto px-4 pt-8">
            <transition name="animate__animated" enter-active-class="animate__fadeIn animate__faster" mode="out-in">

                <!-- –í–ò–¢–†–ò–ù–ê -->
                <div v-if="view === 'home'" key="home">
                    <div class="mb-8 space-y-4">
                        <input v-model="searchQuery" type="text" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –≥–æ—Ä–æ–¥–∞..." class="w-full glass p-4 rounded-2xl">
                        <div class="flex gap-2 overflow-x-auto pb-2">
                            <button v-for="c in categories" @click="filters.cat = c" 
                                :class="filters.cat === c ? 'bg-[#00ffaa] text-black' : 'glass opacity-50'"
                                class="px-5 py-2 rounded-full text-[10px] font-black uppercase whitespace-nowrap">
                                {{c}}
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div v-for="item in sortedItems" :key="item.id" @click="openItem(item)" class="glass rounded-[2rem] p-3 relative group cursor-pointer hover:border-[#00ffaa]/50 transition-all">
                            <div class="aspect-square rounded-[1.5rem] overflow-hidden mb-3 bg-black/20">
                                <img :src="item.img" class="w-full h-full object-cover group-hover:scale-105 transition-transform">
                                <div v-if="item.status === 'sold'" class="absolute inset-0 bg-black/60 flex items-center justify-center">
                                    <span class="border-2 border-red-500 text-red-500 px-2 py-1 rounded text-[10px] font-bold uppercase -rotate-12">–ü—Ä–æ–¥–∞–Ω–æ</span>
                                </div>
                            </div>
                            <h3 class="text-[11px] font-black truncate uppercase px-1">{{item.title}}</h3>
                            <div class="flex justify-between items-center mt-1 px-1">
                                <span class="text-[#00ffaa] font-brand text-[10px]">{{item.price}} ‚ÇΩ</span>
                                <div class="flex gap-1">
                                    <span v-if="userMap[item.user_id]?.has_crown">üëë</span>
                                    <span v-if="userMap[item.user_id]?.is_verified">‚úÖ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ö–û–ú–ê–ù–î–ù–´–ô –¶–ï–ù–¢–† (–ê–î–ú–ò–ù–ö–ê) -->
                <div v-else-if="view === 'admin' && isAdmin" class="max-w-4xl mx-auto pb-10" key="admin">
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="font-brand text-2xl italic text-[#ff3366] uppercase">–ö–æ–º–∞–Ω–¥–Ω—ã–π –¶–µ–Ω—Ç—Ä</h2>
                        <button @click="view = 'profile'" class="text-[10px] glass px-4 py-2 rounded-xl font-black uppercase">–ù–∞–∑–∞–¥</button>
                    </div>

                    <div class="space-y-4">
                        <div v-for="u in dbUsers" :key="u.id" 
                            class="glass p-5 rounded-3xl flex flex-col md:flex-row items-center justify-between gap-4"
                            :class="{'admin-card': u.is_admin}">
                            
                            <div class="flex items-center gap-4 w-full">
                                <div class="relative">
                                    <img :src="u.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${u.name}`" class="w-14 h-14 rounded-2xl object-cover">
                                    <div v-if="u.is_banned" class="absolute inset-0 bg-red-600/60 rounded-2xl flex items-center justify-center text-xs">üö´</div>
                                </div>
                                <div class="flex-1">
                                    <div class="text-sm font-black flex items-center gap-2">
                                        {{u.name}} 
                                        <span v-if="u.has_crown">üëë</span>
                                        <span v-if="u.is_verified">‚úÖ</span>
                                        <span v-if="u.tg_id == MASTER_ADMIN_ID" class="text-[8px] bg-[#ff3366] px-2 py-0.5 rounded text-white">OWNER</span>
                                    </div>
                                    <div class="text-[9px] opacity-40 uppercase font-bold">
                                        –í–∞—Ä–Ω—ã: <span :class="u.strikes >= 3 ? 'text-red-500' : ''">{{u.strikes || 0}}/3</span> ‚Ä¢ ID: {{u.tg_id}}
                                    </div>
                                    <div v-if="u.strike_reason" class="text-[8px] text-orange-400 mt-1 italic">"{{u.strike_reason}}"</div>
                                </div>
                            </div>

                            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                            <div class="flex flex-wrap gap-2 w-full md:w-auto justify-end">
                                <!-- –¢–æ–ª—å–∫–æ –¥–ª—è –°–æ–∑–¥–∞—Ç–µ–ª—è -->
                                <template v-if="isCreator && u.tg_id != MASTER_ADMIN_ID">
                                    <button @click="toggleAdminRole(u)" class="p-2 glass rounded-xl text-[9px] font-black" :class="u.is_admin ? 'text-red-500' : 'text-blue-500'">
                                        {{ u.is_admin ? '–°–ù–Ø–¢–¨ –ê–î–ú' : '–î–ê–¢–¨ –ê–î–ú' }}
                                    </button>
                                    <button @click="toggleCrown(u)" class="w-10 h-10 glass rounded-xl flex items-center justify-center">{{ u.has_crown ? 'üëë' : '‚ö™' }}</button>
                                    <button @click="toggleVerify(u)" class="w-10 h-10 glass rounded-xl flex items-center justify-center">{{ u.is_verified ? '‚úÖ' : '‚ö™' }}</button>
                                </template>
                                
                                <!-- –ú–æ–¥–µ—Ä–∞—Ü–∏—è (–¥–æ—Å—Ç—É–ø–Ω–∞ –∞–¥–º–∏–Ω–∞–º) -->
                                <template v-if="u.tg_id != MASTER_ADMIN_ID && u.tg_id != user.tg_id">
                                    <button @click="giveStrike(u)" class="px-3 py-2 glass text-orange-500 text-[9px] font-black rounded-xl">–í–ê–†–ù</button>
                                    <button @click="removeStrike(u)" class="w-10 h-10 glass text-green-500 rounded-xl flex items-center justify-center">‚Ü∫</button>
                                    <button @click="banUser(u)" class="px-3 py-2 bg-red-600/20 text-red-500 rounded-xl text-[9px] font-black">
                                        {{ u.is_banned ? '–†–ê–ó–ë–ê–ù' : '–ë–ê–ù' }}
                                    </button>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –ü–†–û–§–ò–õ–¨ -->
                <div v-else-if="view === 'profile'" class="max-w-2xl mx-auto" key="profile">
                    <!-- –ö–Ω–æ–ø–∫–∞ –∞–¥–º–∏–Ω–∫–∏ -->
                    <div v-if="isAdmin" @click="view = 'admin'" class="mb-6 p-4 rounded-3xl bg-[#ff3366] text-white text-center font-black text-[10px] uppercase shadow-xl cursor-pointer hover:scale-[1.02] transition-transform">
                        –û–¢–ö–†–´–¢–¨ –ö–û–ú–ê–ù–î–ù–´–ô –¶–ï–ù–¢–† üõ†Ô∏è
                    </div>

                    <div class="glass p-8 rounded-[3rem] text-center border-t-8 border-[#00ffaa] relative">
                        <div class="relative inline-block mb-6">
                            <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-32 h-32 rounded-[2.5rem] object-cover ring-4 ring-white/5">
                            <label class="absolute -bottom-2 -right-2 w-10 h-10 bg-[#00ffaa] rounded-xl flex items-center justify-center cursor-pointer shadow-xl border-4 border-[#050505]">
                                <span class="text-sm">üì∏</span>
                                <input type="file" @change="handleAvatarUpload" class="hidden">
                            </label>
                        </div>
                        
                        <h3 class="text-2xl font-black italic uppercase tracking-tighter flex items-center justify-center gap-2">
                            {{user.name}} <span v-if="user.has_crown">üëë</span><span v-if="user.is_verified">‚úÖ</span>
                        </h3>
                        
                        <div class="flex justify-center gap-4 mt-6">
                            <button @click="logout" class="text-red-500 font-black uppercase text-[10px] opacity-50 hover:opacity-100">–í—ã—Ö–æ–¥</button>
                        </div>
                    </div>

                    <div class="mt-10">
                        <h3 class="font-brand text-xs uppercase mb-6 opacity-40">–ú–æ–∏ –æ–±—ä—è–≤–ª–µ–Ω–∏—è</h3>
                        <div v-if="myItems.length" class="space-y-3">
                            <div v-for="item in myItems" :key="item.id" class="glass p-4 rounded-3xl flex items-center justify-between">
                                <div class="flex items-center gap-4">
                                    <img :src="item.img" class="w-12 h-12 rounded-xl object-cover">
                                    <div class="text-[11px] font-black uppercase">{{item.title}}</div>
                                </div>
                                <button @click="deleteItem(item.id)" class="text-red-500 font-black text-[10px]">–£–î–ê–õ–ò–¢–¨</button>
                            </div>
                        </div>
                        <div v-else class="text-center py-10 glass rounded-3xl opacity-20 text-xs uppercase font-black">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ª–æ—Ç–æ–≤</div>
                    </div>
                </div>

                <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã (Add, Auth, Product) –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –≤ –ø—Ä–æ—à–ª–æ–º –ø—Ä–∏–º–µ—Ä–µ, –Ω–æ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ fetchData() -->
                <!-- [–í—Å—Ç–∞–≤—å –∑–¥–µ—Å—å —Å–µ–∫—Ü–∏–∏ Product, Add, Auth –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã] -->

            </transition>
        </main>

        <!-- –ú–ï–ù–Æ -->
        <nav class="fixed bottom-6 inset-x-6 z-[100] max-w-md mx-auto">
            <div class="glass rounded-[2.5rem] p-3 flex justify-between items-center shadow-2xl backdrop-blur-3xl border-white/10">
                <button @click="view = 'home'" :class="{active: view === 'home'}" class="nav-item flex-1 flex flex-col items-center py-2">
                    <span class="text-xl">üè†</span>
                    <span class="text-[8px] font-black uppercase mt-1">–í–∏—Ç—Ä–∏–Ω–∞</span>
                </button>
                <button @click="user ? view = 'add' : view = 'auth'" :class="{active: view === 'add'}" class="nav-item flex-1 flex flex-col items-center py-2">
                    <span class="text-xl">‚ûï</span>
                    <span class="text-[8px] font-black uppercase mt-1">–ü—Ä–æ–¥–∞—Ç—å</span>
                </button>
                <button @click="user ? (view = 'profile' || view === 'admin') : view = 'auth'" :class="{active: view === 'profile' || view === 'admin'}" class="nav-item flex-1 flex flex-col items-center py-2">
                    <span class="text-xl">üë§</span>
                    <span class="text-[8px] font-black uppercase mt-1">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </button>
            </div>
        </nav>
    </div>
</div>

<script>
const { createApp } = Vue;

const SUPABASE_URL = 'https://gcxnstwsqkmdotqblkfd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeG5zdHdzcWttZG90cWJsa2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDI3MzIsImV4cCI6MjA4MjM3ODczMn0.79gdNrKNRcdPTbban-6uK3GP5Czyq-II7kRHaRyfvqE';
const BOT_TOKEN = '7688454041:AAFFBc0Ye7RRq0RFuSst_QfTqQ0TpQu9aWI';
const MASTER_ADMIN_ID = 1735153058;

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

createApp({
    data() {
        return {
            ageVerified: localStorage.getItem('vape_age_v3') === 'true',
            loading: true, view: 'home',
            user: JSON.parse(localStorage.getItem('vape_user_v3')) || null,
            items: [], dbUsers: [], userMap: {},
            categories: ['–í—Å–µ', '–ü–æ–¥—ã', '–ú–æ–¥—ã', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ó–∞–ø—á–∞—Å—Ç–∏', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'],
            filters: { cat: '–í—Å–µ' }, searchQuery: '', toasts: [],
            auth: { name: '' }, authStep: 'input', verifyCode: '',
            newItem: { title: '', category: '–í—Å–µ', price: null, city: '', desc_text: '', tg_user: '', img: '' },
            publishing: false, MASTER_ADMIN_ID: MASTER_ADMIN_ID
        }
    },
    computed: {
        isCreator() { return this.user && this.user.tg_id == MASTER_ADMIN_ID; },
        isAdmin() { return this.user && (this.user.is_admin || this.isCreator); },
        sortedItems() {
            return this.items.filter(i => {
                const matchCat = this.filters.cat === '–í—Å–µ' || i.category === this.filters.cat;
                const matchSearch = i.title.toLowerCase().includes(this.searchQuery.toLowerCase()) || i.city.toLowerCase().includes(this.searchQuery.toLowerCase());
                return matchCat && matchSearch;
            }).sort((a,b) => b.id - a.id);
        },
        myItems() { return this.user ? this.items.filter(i => i.user_id === this.user.id) : []; }
    },
    async mounted() {
        if (this.ageVerified) await this.init();
        else this.loading = false;
        
        client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, () => this.fetchData()).subscribe();
        client.channel('any_users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => this.fetchData()).subscribe();
    },
    methods: {
        async init() { this.loading = true; await this.fetchData(); this.loading = false; },
        async fetchData() {
            const { data: it } = await client.from('items').select('*').order('id', {ascending: false});
            const { data: us } = await client.from('users').select('*').order('id', {ascending: true});
            this.items = it || [];
            this.dbUsers = us || [];
            
            // –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º —é–∑–µ—Ä–æ–≤
            const map = {};
            this.dbUsers.forEach(u => map[u.id] = u);
            this.userMap = map;

            if (this.user) {
                const current = this.dbUsers.find(u => u.id === this.user.id);
                if (current) {
                    this.user = current;
                    localStorage.setItem('vape_user_v3', JSON.stringify(this.user));
                    if (current.is_banned) this.logout();
                }
            }
        },
        notify(msg) {
            const id = Date.now();
            this.toasts.push({ id, msg });
            setTimeout(() => this.toasts = this.toasts.filter(t => t.id !== id), 3000);
        },
        verifyAge() { this.ageVerified = true; localStorage.setItem('vape_age_v3', 'true'); this.init(); },
        
        // --- ADMIN METHODS ---
        async toggleAdminRole(u) {
            await client.from('users').update({ is_admin: !u.is_admin }).eq('id', u.id);
            this.notify('–°—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω');
        },
        async toggleVerify(u) {
            await client.from('users').update({ is_verified: !u.is_verified }).eq('id', u.id);
            this.notify('–í–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∏–∑–º–µ–Ω–µ–Ω–∞');
        },
        async toggleCrown(u) {
            await client.from('users').update({ has_crown: !u.has_crown }).eq('id', u.id);
            this.notify('–ö–æ—Ä–æ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
        },
        async giveStrike(u) {
            const reason = prompt(`–ü—Ä–∏—á–∏–Ω–∞ –≤–∞—Ä–Ω–∞ –¥–ª—è ${u.name}:`);
            if (!reason) return;
            const newStrikes = (u.strikes || 0) + 1;
            await client.from('users').update({ 
                strikes: newStrikes, 
                strike_reason: reason, 
                is_banned: newStrikes >= 3 
            }).eq('id', u.id);
            this.notify(`–í–∞—Ä–Ω –≤—ã–¥–∞–Ω (${newStrikes}/3)`);
        },
        async removeStrike(u) {
            await client.from('users').update({ strikes: 0, strike_reason: '' }).eq('id', u.id);
            this.notify('–í–∞—Ä–Ω—ã –æ–±–Ω—É–ª–µ–Ω—ã');
        },
        async banUser(u) {
            await client.from('users').update({ is_banned: !u.is_banned }).eq('id', u.id);
            this.notify(u.is_banned ? '–†–∞–∑–±–∞–Ω–µ–Ω' : '–ó–∞–±–∞–Ω–µ–Ω ‚ùå');
        },
        
        // --- CORE METHODS ---
        async deleteItem(id) {
            if(confirm('–£–¥–∞–ª–∏—Ç—å?')) {
                await client.from('items').delete().eq('id', id);
                this.notify('–£–¥–∞–ª–µ–Ω–æ');
            }
        },
        logout() {
            this.user = null;
            localStorage.removeItem('vape_user_v3');
            this.view = 'home';
            this.notify('–°–µ—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        },
        // [–ú–µ—Ç–æ–¥—ã Auth, Upload, Compress –∏ –ø—Ä–æ—á–∏–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞]
    }
}).mount('#app')
</script>
</body>
</html>
