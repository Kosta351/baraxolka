<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bazar Premium</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Manrope:wght@400;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --accent: #00ffaa; --bg: #030303; --card: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08); }
        body { font-family: 'Manrope', sans-serif; background: #000; color: #fff; overflow-x: hidden; }
        
        #app { 
            max-width: 500px; margin: 0 auto; min-height: 100vh; background: var(--bg);
            position: relative; border-left: 1px solid var(--border); border-right: 1px solid var(--border);
            background-image: radial-gradient(circle at 50% -10%, #00ffaa15, transparent);
        }

        .font-brand { font-family: 'Unbounded', sans-serif; }
        .glass { background: var(--card); backdrop-filter: blur(25px); border: 1px solid var(--border); }
        .btn-prime { background: linear-gradient(135deg, var(--accent), #00d4ff); color: #000; font-weight: 800; border-radius: 1.2rem; }
        
        .cat-chip.active { background: var(--accent) !important; color: #000 !important; font-weight: 900; }
        .rank-3 { color: #ff3366; text-shadow: 0 0 10px rgba(255, 51, 102, 0.4); font-weight: 900; }
        .rank-2 { color: #a855f7; font-weight: 800; }
        
        [v-cloak] { display: none; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .input-group { position: relative; margin-bottom: 20px; border-bottom: 1px solid var(--border); }
        .input-group input, .input-group textarea { width: 100%; background: transparent; padding: 15px 5px; outline: none; font-size: 14px; color: white; }
        .input-group label { position: absolute; left: 5px; top: 15px; font-size: 10px; text-transform: uppercase; opacity: 0.3; transition: 0.3s; pointer-events: none; }
        .input-group input:focus ~ label, .input-group input:not(:placeholder-shown) ~ label { top: -5px; color: var(--accent); opacity: 1; font-size: 8px; }
    </style>
</head>
<body class="pb-32">

<div id="app" v-cloak>
    
    <!-- –¢–ï–• –†–ê–ë–û–¢–´ -->
    <div v-if="settings.is_maintenance && !isAdmin" class="fixed inset-0 z-[10001] bg-[#030303] flex items-center justify-center p-8 text-center">
        <h1 class="font-brand text-2xl text-[#ff3366] animate-pulse">–¢–ï–•. –†–ê–ë–û–¢–´</h1>
    </div>

    <!-- AGE GATE -->
    <div v-if="!ageVerified" class="fixed inset-0 z-[9999] bg-[#030303] flex items-center justify-center p-6 text-center">
        <div class="glass p-12 rounded-[4rem] w-full border-[#00ffaa22]">
            <h1 class="font-brand text-2xl mb-8">BAZAR PRO</h1>
            <button @click="verifyAge" class="btn-prime w-full py-6 uppercase font-black">–ú–Ω–µ –µ—Å—Ç—å 18 –ª–µ—Ç</button>
        </div>
    </div>

    <div v-else>
        <header class="p-6 flex justify-between items-center">
            <h1 @click="view = 'home'" class="font-brand text-2xl font-black italic cursor-pointer">BAZAR<span class="text-[#00ffaa]">.</span></h1>
            <div v-if="user" @click="view = 'profile'" class="w-12 h-12 rounded-2xl glass p-1 cursor-pointer overflow-hidden ring-2 ring-white/5">
                <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-full h-full object-cover rounded-xl">
            </div>
        </header>

        <main class="px-6">
            <!-- –ì–õ–ê–í–ù–ê–Ø -->
            <div v-if="view === 'home'">
                <div class="mb-6 space-y-4">
                    <input v-model="searchQuery" type="text" placeholder="–ü–æ–∏—Å–∫..." class="w-full glass p-4 rounded-2xl outline-none">
                    <div class="flex gap-2 overflow-x-auto no-scrollbar">
                        <div v-for="c in categories" @click="filters.cat = c" :class="['cat-chip px-5 py-2 rounded-full text-[10px] uppercase glass cursor-pointer', filters.cat === c ? 'active' : 'opacity-40']">{{c}}</div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="item in sortedItems" :key="item.id" @click="openItem(item)" class="glass p-3 rounded-[2rem] relative active:scale-95 transition-all">
                        <img :src="item.img" class="aspect-square rounded-[1.5rem] object-cover mb-2">
                        <div class="text-[10px] font-black uppercase truncate text-center">{{item.title}}</div>
                        <div class="text-[#00ffaa] font-brand text-[10px] text-center mt-1">{{item.price}} ‚ÇΩ</div>
                    </div>
                </div>
            </div>

            <!-- –ö–ê–†–¢–û–ß–ö–ê –¢–û–í–ê–†–ê -->
            <div v-if="view === 'product' && selectedItem">
                <button @click="view = 'home'" class="mb-4 opacity-40 text-xs">‚Üê –ù–ê–ó–ê–î</button>
                <div class="glass rounded-[2.5rem] overflow-hidden">
                    <img :src="activeImg || selectedItem.img" class="w-full aspect-square object-cover">
                    <div class="p-6">
                        <h2 class="font-brand text-xl mb-4 italic">{{selectedItem.title}}</h2>
                        <div @click="openUserProfile(selectedItem.user_id)" class="flex items-center gap-3 p-3 glass rounded-2xl mb-6 cursor-pointer">
                            <img :src="userMap[selectedItem.user_id]?.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=user`" class="w-8 h-8 rounded-lg object-cover">
                            <div class="text-[10px] font-black uppercase">{{selectedItem.seller_name}} <span class="text-[#00ffaa]">‚òÖ {{userMap[selectedItem.user_id]?.rating || '5.0'}}</span></div>
                        </div>
                        <p class="text-sm opacity-60 mb-8 whitespace-pre-wrap">{{selectedItem.desc_text}}</p>
                        <button @click="contactSeller" class="btn-prime w-full py-5 font-black uppercase italic">–ù–∞–ø–∏—Å–∞—Ç—å –≤ TG</button>
                    </div>
                </div>
            </div>

            <!-- –ü–£–ë–õ–ò–ß–ù–´–ô –ü–†–û–§–ò–õ–¨ -->
            <div v-if="view === 'user-profile' && viewedUser">
                <button @click="view = 'product'" class="mb-4 opacity-40 text-xs">‚Üê –ö –¢–û–í–ê–†–£</button>
                <div class="glass p-8 rounded-[3rem] text-center mb-6">
                    <img :src="viewedUser.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${viewedUser.name}`" class="w-20 h-20 rounded-[2rem] mx-auto mb-4 object-cover">
                    <h2 class="font-brand text-xl italic">{{viewedUser.name}}</h2>
                    <div class="text-[#00ffaa] text-[10px] font-black mt-2">–†–ï–ô–¢–ò–ù–ì: {{viewedUser.rating}} ‚òÖ</div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div v-for="item in viewedUserItems" @click="openItem(item)" class="glass p-3 rounded-2xl text-center">
                        <img :src="item.img" class="aspect-square rounded-xl object-cover mb-2">
                        <div class="text-[9px] font-black truncate uppercase">{{item.title}}</div>
                    </div>
                </div>
            </div>

            <!-- –õ–ò–ß–ù–´–ô –ü–†–û–§–ò–õ–¨ -->
            <div v-if="view === 'profile' && user">
                <div v-if="isAdmin" @click="view = 'admin'" class="p-4 rounded-2xl bg-[#00ffaa]/10 border border-[#00ffaa]/20 text-center font-black text-xs text-[#00ffaa] mb-4 cursor-pointer">–ê–î–ú–ò–ù-–¶–ï–ù–¢–† üõ†Ô∏è</div>
                <div class="glass p-8 rounded-[3rem] text-center mb-6">
                    <div class="relative inline-block mx-auto mb-4">
                        <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-20 h-20 rounded-[2rem] object-cover">
                        <label class="absolute -bottom-2 -right-2 bg-[#00ffaa] p-2 rounded-xl cursor-pointer text-black">üì∏<input type="file" @change="handleAvatarUpload" class="hidden"></label>
                    </div>
                    <h2 class="font-brand text-xl italic leading-none">{{user.name}}</h2>
                    <div :class="'rank-'+user.rank" class="text-[8px] font-black uppercase mt-1">{{getRankName(user)}}</div>
                </div>
                <div class="flex gap-2 p-1 glass rounded-2xl mb-4">
                    <button v-for="t in ['my', 'edit']" @click="profileTab = t" :class="['flex-1 py-3 rounded-xl text-[9px] font-black uppercase transition-all', profileTab === t ? 'bg-white/10 text-[#00ffaa]' : 'opacity-40']">{{t === 'my' ? '–ú–æ–∏' : '–ù–∞—Å—Ç—Ä–æ–π–∫–∏'}}</button>
                </div>
                <div v-if="profileTab === 'my'" class="space-y-3">
                    <div v-for="item in myItems" :key="item.id" class="glass p-4 rounded-2xl flex items-center justify-between">
                        <div class="flex items-center gap-3"><img :src="item.img" class="w-10 h-10 rounded-lg object-cover"><div class="text-[10px] font-black uppercase truncate max-w-[150px]">{{item.title}}</div></div>
                        <button @click="deleteItem(item.id)" class="text-red-500">‚úï</button>
                    </div>
                </div>
                <div v-if="profileTab === 'edit'" class="glass p-6 rounded-3xl space-y-4 text-left">
                    <div class="input-group"><input v-model="editUser.name" type="text" placeholder=" "><label>–ù–∏–∫–Ω–µ–π–º</label></div>
                    <div class="input-group"><textarea v-model="editUser.bio" placeholder=" "></textarea><label>–û —Å–µ–±–µ</label></div>
                    <button @click="saveProfile" class="btn-prime w-full py-4 uppercase font-black">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button @click="logout" class="w-full text-red-500 text-[10px] font-black uppercase mt-4">–í—ã–π—Ç–∏</button>
                </div>
            </div>

            <!-- –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ -->
            <div v-if="view === 'admin' && isAdmin" class="animate__animated animate__fadeIn">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="font-brand text-xl text-[#ff3366] italic uppercase">Control</h2>
                    <button @click="view = 'profile'" class="glass px-4 py-2 rounded-xl text-[8px] uppercase">–ù–∞–∑–∞–¥</button>
                </div>
                <div class="flex gap-2 mb-6">
                    <button @click="adminTab = 'users'" :class="['flex-1 py-3 rounded-xl text-[9px] font-black uppercase glass', adminTab === 'users' ? 'text-blue-400 border-blue-400/30' : 'opacity-40']">–Æ–∑–µ—Ä—ã</button>
                    <button @click="adminTab = 'items'" :class="['flex-1 py-3 rounded-xl text-[9px] font-black uppercase glass', adminTab === 'items' ? 'text-blue-400 border-blue-400/30' : 'opacity-40']">–õ–æ—Ç—ã</button>
                </div>
                <!-- –°–ø–∏—Å–æ–∫ —é–∑–µ—Ä–æ–≤ -->
                <div v-if="adminTab === 'users'" class="space-y-3">
                    <div v-for="u in dbUsers" :key="u.id" class="glass p-4 rounded-[2rem]">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-3"><img :src="u.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${u.name}`" class="w-10 h-10 rounded-xl object-cover"><div><div class="text-[10px] font-black uppercase leading-none mb-1">{{u.name}}</div><div :class="'rank-'+u.rank" class="text-[7px] font-bold uppercase">{{getRankName(u)}}</div></div></div>
                            <div v-if="Number(u.tg_id) !== Number(MASTER_ADMIN_ID)" class="flex gap-1"><button @click="giveStrike(u)" class="w-8 h-8 glass rounded-lg text-xs">‚ö†Ô∏è</button><button @click="banUser(u)" class="w-8 h-8 glass rounded-lg text-xs text-red-500">üö´</button></div>
                        </div>
                        <div v-if="Number(u.tg_id) !== Number(MASTER_ADMIN_ID)" class="grid grid-cols-3 gap-2 pt-4 border-t border-white/5">
                            <button @click="changeRank(u, 0)" class="py-2 glass rounded-lg text-[7px] uppercase font-black">–Æ–∑–µ—Ä</button>
                            <button @click="changeRank(u, 1)" class="py-2 glass rounded-lg text-[7px] uppercase font-black text-blue-400">–ê–¥–º–∏–Ω</button>
                            <button @click="changeRank(u, 2)" class="py-2 glass rounded-lg text-[7px] uppercase font-black text-purple-400">–°—Ç–∞—Ä—à–∏–π</button>
                        </div>
                    </div>
                </div>
                <!-- –í—Å–µ –ª–æ—Ç—ã -->
                <div v-else-if="adminTab === 'items'" class="space-y-3">
                    <div v-for="item in items" :key="item.id" class="glass p-4 rounded-2xl flex items-center justify-between">
                        <div class="flex items-center gap-3"><img :src="item.img" class="w-10 h-10 rounded-lg object-cover"><div><div class="text-[9px] font-black uppercase">{{item.title}}</div><div class="text-[7px] opacity-40 uppercase">–û—Ç: {{item.seller_name}}</div></div></div>
                        <button @click="deleteItem(item.id)" class="text-red-500">‚úï</button>
                    </div>
                </div>
            </div>

            <!-- –î–û–ë–ê–í–õ–ï–ù–ò–ï -->
            <div v-if="view === 'add'">
                <h2 class="font-brand text-2xl uppercase italic mb-8">–ù–æ–≤—ã–π –ª–æ—Ç</h2>
                <div class="grid grid-cols-3 gap-3 mb-8">
                    <div v-for="n in [1,2,3]" :key="n" @click="triggerFile(n)" :class="['aspect-square glass rounded-[2rem] flex items-center justify-center cursor-pointer border-2 border-dashed overflow-hidden', getNewImg(n) ? 'border-[#00ffaa]/40' : 'border-white/10']">
                        <img v-if="getNewImg(n)" :src="getNewImg(n)" class="w-full h-full object-cover">
                        <div v-else class="text-xs opacity-20 uppercase font-black">–§–û–¢–û</div>
                        <input type="file" :ref="'file'+n" @change="e => handleFileUpload(e, n)" class="hidden">
                    </div>
                </div>
                <div class="space-y-2">
                    <div class="input-group"><input v-model="newItem.title" type="text" placeholder=" "><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label></div>
                    <div class="input-group"><input v-model.number="newItem.price" type="number" placeholder=" "><label>–¶–µ–Ω–∞ ‚ÇΩ</label></div>
                    <div class="input-group"><input v-model="newItem.city" type="text" placeholder=" "><label>–ì–æ—Ä–æ–¥</label></div>
                    <div class="input-group"><input v-model="newItem.tg_user" type="text" placeholder=" "><label>–¢–µ–ª–µ–≥—Ä–∞–º @...</label></div>
                    <textarea v-model="newItem.desc_text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." class="w-full glass p-4 rounded-2xl h-32 outline-none border-none"></textarea>
                    <button @click="createListing" :disabled="publishing || !newItem.img" class="btn-prime w-full py-6 uppercase font-black italic">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                </div>
            </div>

            <!-- –í–•–û–î -->
            <div v-if="view === 'auth'" class="py-10 text-center">
                <div class="glass p-10 rounded-[3rem]">
                    <h2 class="font-brand text-2xl uppercase mb-8 italic">Bazar Auth</h2>
                    <input v-model="auth.name" type="text" placeholder="–ü—Ä–∏–¥—É–º–∞–π –Ω–∏–∫" class="w-full glass p-5 rounded-2xl mb-4 text-center font-bold outline-none">
                    <button @click="startAuth" class="btn-prime w-full py-5 uppercase font-black">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
                    <div v-if="verifyCode" class="mt-8"><div class="text-4xl font-brand text-[#00ffaa] mb-4">{{verifyCode}}</div><p class="text-[9px] opacity-40 uppercase font-black">–û—Ç–ø—Ä–∞–≤—å –±–æ—Ç—É @your_vape_bot</p></div>
                </div>
            </div>
        </main>

        <nav class="fixed bottom-8 left-1/2 -translate-x-1/2 z-[100] w-[calc(100%-48px)] max-w-[452px]">
            <div class="glass rounded-[2.5rem] p-3 flex justify-around items-center shadow-2xl backdrop-blur-3xl border-white/10">
                <button @click="view = 'home'" :class="['tab-bar-item p-3', {active: view === 'home'}]">üè†</button>
                <button @click="user ? view = 'add' : view = 'auth'" :class="['tab-bar-item p-3', {active: view === 'add'}]"><div class="bg-[#00ffaa] text-black w-10 h-10 rounded-2xl flex items-center justify-center font-black text-xl">+</div></button>
                <button @click="user ? (view = 'profile' || view === 'admin') : view = 'auth'" :class="['tab-bar-item p-3', {active: view === 'profile' || view === 'admin'}]">üë§</button>
            </div>
        </nav>
    </div>
</div>

<script>
const { createApp } = Vue;
const SUPABASE_URL = 'https://gcxnstwsqkmdotqblkfd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeG5zdHdzcWttZG90cWJsa2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDI3MzIsImV4cCI6MjA4MjM3ODczMn0.79gdNrKNRcdPTbban-6uK3GP5Czyq-II7kRHaRyfvqE';
const BOT_TOKEN = '7688454041:AAFFBc0Ye7RRq0RFuSst_QfTqQ0TpQu9aWI';
const MASTER_ADMIN_ID = 1735153058;
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

createApp({
    data() {
        return {
            ageVerified: localStorage.getItem('bazar_v2_age') === 'true',
            view: 'home', profileTab: 'my', adminTab: 'users',
            user: JSON.parse(localStorage.getItem('bazar_v2_user')) || null,
            items: [], dbUsers: [], userMap: {}, viewedUser: null,
            settings: { announcement: '', is_maintenance: false },
            categories: ['–í—Å–µ', '–ü–æ–¥—ã', '–ú–æ–¥—ã', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ó–∞–ø—á–∞—Å—Ç–∏', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'],
            filters: { cat: '–í—Å–µ' }, searchQuery: '',
            auth: { name: '' }, verifyCode: '',
            newItem: { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '', img2: '', img3: '' },
            editUser: { name: '', bio: '' },
            publishing: false, selectedItem: null, activeImg: null, MASTER_ADMIN_ID: MASTER_ADMIN_ID
        }
    },
    computed: {
        isAdmin() { 
            if (!this.user) return false;
            // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê –ü–û ID –°–û–ó–î–ê–¢–ï–õ–Ø
            return Number(this.user.tg_id) === Number(this.MASTER_ADMIN_ID) || this.user.rank >= 1; 
        },
        sortedItems() {
            let res = this.items;
            if (this.filters.cat !== '–í—Å–µ') res = res.filter(i => i.category === this.filters.cat);
            if (this.searchQuery) { const q = this.searchQuery.toLowerCase(); res = res.filter(i => i.title.toLowerCase().includes(q) || i.city.toLowerCase().includes(q)); }
            return res.sort((a,b) => b.id - a.id);
        },
        myItems() { return this.user ? this.items.filter(i => i.user_id === this.user.id) : []; },
        favoriteItems() { return this.items.filter(i => this.user?.favorites?.includes(i.id)); },
        viewedUserItems() { return this.viewedUser ? this.items.filter(i => i.user_id === this.viewedUser.id) : []; }
    },
    async mounted() {
        if (this.ageVerified) await this.init();
        client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, () => this.fetchData()).subscribe();
        client.channel('any_users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => this.fetchData()).subscribe();
        client.channel('settings').on('postgres_changes', { event: '*', schema: 'public', table: 'settings' }, () => this.fetchSettings()).subscribe();
    },
    methods: {
        async init() { await this.fetchData(); await this.fetchSettings(); },
        async fetchData() {
            const { data: it } = await client.from('items').select('*');
            const { data: us } = await client.from('users').select('*');
            this.items = it || []; this.dbUsers = us || [];
            this.dbUsers.forEach(u => this.userMap[u.id] = u);
            if (this.user) {
                const f = this.dbUsers.find(u => Number(u.tg_id) === Number(this.user.tg_id));
                if (f) { this.user = f; this.editUser.name = f.name; this.editUser.bio = f.bio || ''; localStorage.setItem('bazar_v2_user', JSON.stringify(f)); }
            }
        },
        async fetchSettings() { const { data } = await client.from('settings').select('*').eq('id', 1).single(); if (data) this.settings = data; },
        async createListing() {
            if (this.publishing || !this.user) return;
            this.publishing = true;
            const { error } = await client.from('items').insert([{ ...this.newItem, user_id: this.user.id, seller_name: this.user.name, status: 'active' }]);
            if(!error) { this.view = 'home'; this.newItem = { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '', img2: '', img3: '' }; await this.fetchData(); }
            this.publishing = false;
        },
        async saveProfile() {
            await client.from('users').update({ name: this.editUser.name, bio: this.editUser.bio }).eq('id', this.user.id);
            alert("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"); await this.fetchData();
        },
        async changeRank(u, r) { await client.from('users').update({ rank: r, is_admin: r >= 1 }).eq('id', u.id); await this.fetchData(); },
        async openUserProfile(userId) { const t = this.dbUsers.find(u => u.id === userId); if(t) { this.viewedUser = t; this.view = 'user-profile'; window.scrollTo(0,0); } },
        getRankName(u) { if (Number(u.tg_id) === Number(this.MASTER_ADMIN_ID)) return '–°–æ–∑–¥–∞—Ç–µ–ª—å üëë'; return ['–Æ–∑–µ—Ä', '–ê–¥–º–∏–Ω', '–°—Ç. –ê–¥–º–∏–Ω'][u.rank || 0]; },
        verifyAge() { this.ageVerified = true; localStorage.setItem('bazar_v2_age', 'true'); this.init(); },
        async startAuth() {
            if (!this.auth.name) return;
            this.verifyCode = Math.floor(1000 + Math.random() * 9000).toString();
            const poll = setInterval(async () => {
                const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-20`);
                const data = await res.json();
                const msg = data.result?.find(u => u.message?.text === this.verifyCode);
                if (msg) { clearInterval(poll); await this.finalizeAuth(msg.message.from); }
            }, 3000);
        },
        async finalizeAuth(tg) {
            let { data: ex } = await client.from('users').select('*').eq('tg_id', tg.id).single();
            if (!ex) { const r = (Number(tg.id) === Number(this.MASTER_ADMIN_ID)) ? 3 : 0; const { data: nu } = await client.from('users').insert([{ tg_id: tg.id, name: this.auth.name, rank: r, is_admin: r >= 1, favorites: [] }]).select().single(); ex = nu; }
            this.user = ex; localStorage.setItem('bazar_v2_user', JSON.stringify(ex)); location.reload();
        },
        async deleteItem(id) { if (confirm("–£–¥–∞–ª–∏—Ç—å?")) { await client.from('items').delete().eq('id', id); await this.fetchData(); } },
        async toggleSold(item) { await client.from('items').update({ status: item.status === 'sold' ? 'active' : 'sold' }).eq('id', item.id); await this.fetchData(); },
        triggerFile(n) { this.$refs['file'+n][0].click() },
        getNewImg(n) { return n === 1 ? this.newItem.img : n === 2 ? this.newItem.img2 : this.newItem.img3; },
        handleFileUpload(e, n) {
            const file = e.target.files[0]; const r = new FileReader();
            r.onload = (f) => {
                const i = new Image(); i.src = f.target.result;
                i.onload = () => {
                    const c = document.createElement('canvas'); const max = 800; let w = i.width, h = i.height;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    c.width = w; c.height = h; c.getContext('2d').drawImage(i, 0, 0, w, h);
                    const b = c.toDataURL('image/jpeg', 0.7);
                    if(n === 1) this.newItem.img = b; if(n === 2) this.newItem.img2 = b; if(n === 3) this.newItem.img3 = b;
                };
            };
            r.readAsDataURL(file);
        },
        async handleAvatarUpload(e) {
            const file = e.target.files[0]; const r = new FileReader();
            r.onload = (f) => {
                const i = new Image(); i.src = f.target.result;
                i.onload = async () => {
                    const c = document.createElement('canvas'); c.width = 300; c.height = 300;
                    c.getContext('2d').drawImage(i, 0, 0, 300, 300);
                    const b = c.toDataURL('image/jpeg', 0.8);
                    await client.from('users').update({ avatar: b }).eq('id', this.user.id); await this.fetchData();
                };
            };
            r.readAsDataURL(file);
        },
        openItem(item) { this.selectedItem = item; this.activeImg = item.img; this.view = 'product'; window.scrollTo(0,0); },
        contactSeller() { window.open(`https://t.me/${this.selectedItem.tg_user.replace('@','')}`, '_blank'); },
        async giveStrike(u) { const r = prompt("–ü—Ä–∏—á–∏–Ω–∞:"); if (r) { await client.from('users').update({ strikes: (u.strikes || 0) + 1, strike_reason: r }).eq('id', u.id); await this.fetchData(); } },
        async banUser(u) { if (confirm("–ë–∞–Ω?")) { await client.from('users').update({ is_banned: !u.is_banned }).eq('id', u.id); await this.fetchData(); } },
        async toggleMaintenance() { await client.from('settings').update({ is_maintenance: !this.settings.is_maintenance }).eq('id', 1); },
        logout() { localStorage.clear(); location.reload(); }
    }
}).mount('#app')
</script>
</body>
</html>
