<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bazar Pro | Final Stable</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@400;900&family=Manrope:wght@400;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    
    <style>
        :root { --accent: #00ffaa; --bg: #030303; --card: rgba(255, 255, 255, 0.03); --border: rgba(255, 255, 255, 0.08); }
        body { font-family: 'Manrope', sans-serif; background: var(--bg); color: #fff; overflow-x: hidden; background-image: radial-gradient(circle at 50% -20%, #00ffaa15, transparent); }
        .font-brand { font-family: 'Unbounded', sans-serif; }
        .glass { background: var(--card); backdrop-filter: blur(25px); border: 1px solid var(--border); }
        .btn-prime { background: linear-gradient(135deg, var(--accent), #00d4ff); color: #000; font-weight: 800; transition: 0.3s; border-radius: 1.2rem; }
        
        @keyframes spin-flip {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.2); }
            100% { transform: rotate(360deg) scale(1); }
        }
        .btn-add-wrapper:hover .plus-icon { animation: spin-flip 0.6s ease-in-out; }

        .tab-bar-item { opacity: 0.4; transition: 0.4s; cursor: pointer; }
        .tab-bar-item.active { opacity: 1; color: var(--accent); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        [v-cloak] { display: none; }
        input, textarea, select { background: rgba(255,255,255,0.05) !important; border: 1px solid var(--border) !important; color: white !important; outline: none; }
        
        .rank-creator { color: #ff3366; text-shadow: 0 0 15px rgba(255, 51, 102, 0.6); font-weight: 900; }
        .rank-2 { color: #a855f7; } 
        .rank-1 { color: #38bdf8; }

        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
    </style>
</head>
<body class="pb-32">

<div id="app" v-cloak>
    
    <!-- üîû AGE GATE -->
    <div v-if="!ageVerified" class="fixed inset-0 z-[9999] bg-[#030303] flex items-center justify-center p-6 text-center">
        <div class="glass p-12 rounded-[4rem] max-w-sm w-full border-[#00ffaa22]">
            <div class="w-20 h-20 bg-[#00ffaa] rounded-[2.5rem] mx-auto mb-8 flex items-center justify-center text-black text-4xl font-black">B</div>
            <h1 class="font-brand text-2xl mb-4 italic uppercase">Bazar Pro</h1>
            <p class="text-gray-400 text-xs mb-10 uppercase">–í–∞–º —É–∂–µ –µ—Å—Ç—å 18 –ª–µ—Ç?</p>
            <button @click="verifyAge" class="btn-prime w-full py-6 text-[10px] uppercase tracking-widest shadow-2xl">–î–∞, –≤–æ–π—Ç–∏</button>
        </div>
    </div>

    <div v-else>
        
        <!-- üì¢ –ë–ê–ù–ù–ï–† -->
        <div v-if="settings.announcement" class="bg-gradient-to-r from-[#00ffaa22] via-transparent to-[#00ffaa22] border-b border-[#00ffaa33] py-2 overflow-hidden">
            <div class="whitespace-nowrap animate-[marquee_25s_linear_infinite] text-[9px] font-black uppercase tracking-widest text-[#00ffaa]">
                {{ settings.announcement }}
            </div>
        </div>

        <header class="p-6 pb-2">
            <div class="flex justify-between items-center">
                <div @click="refreshSite" class="cursor-pointer active:scale-95 transition-all">
                    <h1 class="font-brand text-2xl font-black italic tracking-tighter leading-none">BAZAR<span class="text-[#00ffaa]">.</span></h1>
                    <div class="text-[8px] font-bold opacity-30 uppercase mt-1">{{ items.length }} –õ–û–¢–û–í</div>
                </div>
                <div v-if="user" @click="view = 'profile'" class="w-12 h-12 rounded-2xl glass p-1 cursor-pointer overflow-hidden ring-2 ring-white/5 active:scale-90 transition-all">
                    <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-full h-full object-cover rounded-xl">
                </div>
                <button v-else @click="view = 'auth'" class="btn-prime px-6 py-2 text-[10px] uppercase">–í—Ö–æ–¥</button>
            </div>
        </header>

        <main class="px-6 pb-20">
            <transition name="animate__animated" enter-active-class="animate__fadeIn animate__faster" mode="out-in">

                <!-- –í–ò–¢–†–ò–ù–ê -->
                <div v-if="view === 'home'" key="home">
                    <div class="mb-8 space-y-4">
                        <div class="glass rounded-[1.5rem] flex items-center px-4 py-1">
                            <input v-model="searchQuery" type="text" placeholder="–ü–æ–∏—Å–∫..." class="bg-transparent border-none w-full p-4 text-sm text-white focus:ring-0">
                        </div>
                    </div>

                    <div v-if="sortedItems.length" class="grid grid-cols-2 gap-4">
                        <div v-for="item in sortedItems" :key="item.id" @click="openItem(item)" class="glass rounded-[2rem] p-3 relative group active:scale-95 transition-all">
                            <div class="aspect-square rounded-[1.5rem] overflow-hidden mb-3 bg-black/40 relative">
                                <img :src="item.img" class="w-full h-full object-cover">
                                <button @click.stop="toggleFavorite(item.id)" class="absolute top-2 right-2 w-8 h-8 rounded-xl glass flex items-center justify-center text-[10px] z-20">
                                    {{ isFavorite(item.id) ? '‚ù§Ô∏è' : 'ü§ç' }}
                                </button>
                            </div>
                            <h3 class="text-[10px] font-black uppercase truncate">{{item.title}}</h3>
                            <div class="text-[#00ffaa] font-brand text-[11px]">{{item.price}} ‚ÇΩ</div>
                        </div>
                    </div>
                    <div v-else class="text-center py-20 opacity-20 uppercase text-[10px] font-black">–ü—É—Å—Ç–æ</div>
                </div>

                <!-- –ü–†–û–§–ò–õ–¨ -->
                <div v-else-if="view === 'profile' && user" key="profile" class="space-y-6">
                    <div v-if="isAdmin" @click="view = 'admin'" class="p-4 rounded-3xl bg-white/5 border border-white/10 text-center font-black text-[10px] uppercase cursor-pointer">–ö–æ–º–∞–Ω–¥–Ω—ã–π —Ü–µ–Ω—Ç—Ä üõ†Ô∏è</div>
                    <div class="glass p-8 rounded-[3rem] text-center">
                        <div class="relative inline-block mx-auto mb-4">
                            <img :src="user.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${user.name}`" class="w-24 h-24 rounded-[2rem] object-cover ring-4 ring-[#00ffaa]/10">
                            <label class="absolute -bottom-1 -right-1 bg-[#00ffaa] text-black w-8 h-8 rounded-lg flex items-center justify-center cursor-pointer shadow-lg">
                                üì∏ <input type="file" @change="handleAvatarUpload" class="hidden" accept="image/*">
                            </label>
                        </div>
                        <h2 class="font-brand text-xl uppercase italic leading-none">{{user.name}}</h2>
                        <div :class="getUserRankClass(user)" class="text-[8px] font-black uppercase mt-2">{{ getRankName(user) }}</div>
                    </div>

                    <div class="flex gap-2 overflow-x-auto no-scrollbar">
                        <button @click="profileTab = 'my'" :class="['px-6 py-4 rounded-2xl text-[10px] font-black uppercase glass flex-1', {active: profileTab === 'my'}]">–ú–æ–∏ –ª–æ—Ç—ã</button>
                        <button @click="profileTab = 'fav'" :class="['px-6 py-4 rounded-2xl text-[10px] font-black uppercase glass flex-1', {active: profileTab === 'fav'}]">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                        <button @click="profileTab = 'edit'" :class="['px-6 py-4 rounded-2xl text-[10px] font-black uppercase glass flex-1', {active: profileTab === 'edit'}]">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>

                    <div v-if="profileTab === 'my'" class="space-y-3">
                        <div v-for="item in myItems" :key="item.id" class="glass p-4 rounded-3xl flex items-center justify-between">
                            <div class="flex items-center gap-4">
                                <img :src="item.img" class="w-12 h-12 rounded-xl object-cover">
                                <div class="text-[10px] font-black uppercase">{{item.title}}</div>
                            </div>
                            <div class="flex gap-2">
                                <button @click="deleteItem(item.id)" class="text-red-500 p-2">‚úï</button>
                            </div>
                        </div>
                    </div>

                    <div v-else-if="profileTab === 'edit'" class="glass p-8 rounded-[2.5rem] space-y-6">
                        <input v-model="editUser.name" type="text" placeholder="–ò–º—è" class="w-full p-4 glass rounded-2xl text-white">
                        <input v-model="editUser.bio" type="text" placeholder="–û —Å–µ–±–µ" class="w-full p-4 glass rounded-2xl text-white">
                        <button @click="saveProfile" class="btn-prime w-full py-5 text-[10px] font-black uppercase">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button @click="logout" class="w-full text-red-500 text-[10px] font-black uppercase opacity-40 py-4">–í—ã–π—Ç–∏</button>
                    </div>
                </div>

                <!-- –í–•–û–î (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô) -->
                <div v-else-if="view === 'auth'" key="auth" class="max-w-md mx-auto py-10">
                    <div class="glass p-10 rounded-[3.5rem] text-center animate__animated animate__zoomIn">
                        <h2 class="font-brand text-2xl uppercase mb-8 italic">–í—Ö–æ–¥</h2>
                        <input v-model="auth.name" type="text" placeholder="–ù–∏–∫–Ω–µ–π–º" class="w-full p-5 glass rounded-2xl mb-4 text-center font-bold text-white">
                        <button @click="startAuth" class="btn-prime w-full py-5 text-[10px] uppercase shadow-xl">–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥</button>
                        
                        <div v-if="verifyCode" class="mt-8 animate__animated animate__fadeIn">
                            <div class="text-5xl font-brand text-[#00ffaa] mb-6 tracking-widest">{{verifyCode}}</div>
                            <p class="text-[9px] opacity-60 uppercase font-black px-4">
                                –û—Ç–ø—Ä–∞–≤—å –∫–æ–¥ –±–æ—Ç—É:<br>
                                <a href="https://t.me/your_vape_bot" target="_blank" class="text-[#00ffaa]">@your_vape_bot</a>
                            </p>
                            <div class="mt-4 flex items-center justify-center gap-2">
                                <span class="w-1.5 h-1.5 bg-[#00ffaa] rounded-full animate-pulse"></span>
                                <span class="text-[8px] font-black opacity-30 uppercase">–ñ–¥–µ–º —Å–∏–≥–Ω–∞–ª...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- –î–û–ë–ê–í–õ–ï–ù–ò–ï -->
                <div v-else-if="view === 'add'" key="add">
                    <div class="glass p-8 rounded-[3rem] space-y-4">
                        <h2 class="font-brand text-xl uppercase text-center mb-6 italic">–ù–æ–≤—ã–π –ª–æ—Ç</h2>
                        <div class="grid grid-cols-3 gap-3">
                            <div v-for="n in [1,2,3]" :key="n" @click="triggerFile(n)" class="aspect-square glass rounded-2xl flex items-center justify-center cursor-pointer border-2 border-dashed border-white/10 overflow-hidden relative">
                                <img v-if="getNewImg(n)" :src="getNewImg(n)" class="w-full h-full object-cover">
                                <span v-else class="text-xl opacity-20">üì∏</span>
                                <input type="file" :ref="'file'+n" @change="e => handleFileUpload(e, n)" class="hidden">
                            </div>
                        </div>
                        <input v-model="newItem.title" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" class="w-full p-4 glass rounded-2xl">
                        <input v-model.number="newItem.price" type="number" placeholder="–¶–µ–Ω–∞ ‚ÇΩ" class="w-full p-4 glass rounded-2xl">
                        <input v-model="newItem.city" type="text" placeholder="–ì–æ—Ä–æ–¥" class="w-full p-4 glass rounded-2xl">
                        <input v-model="newItem.tg_user" type="text" placeholder="–¢–ì –Ω–∏–∫" class="w-full p-4 glass rounded-2xl">
                        <textarea v-model="newItem.desc_text" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ..." class="w-full p-4 glass rounded-2xl h-32"></textarea>
                        <button @click="createListing" :disabled="publishing || !newItem.img" class="btn-prime w-full py-6 text-[10px] font-black uppercase">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>
                    </div>
                </div>

                <!-- –ê–î–ú–ò–ù–ö–ê -->
                <div v-else-if="view === 'admin' && isAdmin" key="admin" class="space-y-4">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="font-brand text-xl text-[#ff3366] uppercase italic">Admin</h2>
                        <button @click="view = 'profile'" class="text-[10px] glass px-4 py-2 rounded-xl uppercase">–ù–∞–∑–∞–¥</button>
                    </div>
                    <div v-for="u in dbUsers" :key="u.id" class="glass p-4 rounded-3xl space-y-4">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <img :src="u.avatar || `https://api.dicebear.com/7.x/pixel-art/svg?seed=${u.name}`" class="w-10 h-10 rounded-xl object-cover">
                                <div class="text-[10px] font-black uppercase text-left">{{u.name}} <br> <span :class="getUserRankClass(u)">{{ getRankName(u) }}</span></div>
                            </div>
                            <button v-if="u.tg_id != MASTER_ADMIN_ID" @click="banUser(u)" class="w-10 h-10 glass rounded-xl text-red-500 text-xs">üö´</button>
                        </div>
                    </div>
                </div>

                <!-- –¢–û–í–ê–† -->
                <div v-else-if="view === 'product' && selectedItem" key="product">
                    <button @click="view = 'home'" class="mb-6 opacity-30 text-[10px] font-black uppercase">‚Üê –ù–∞–∑–∞–¥</button>
                    <div class="glass rounded-[3rem] overflow-hidden shadow-2xl">
                        <div class="aspect-square relative">
                            <img :src="activeImg || selectedItem.img" class="w-full h-full object-cover transition-all duration-500">
                        </div>
                        <div class="p-8">
                            <h2 class="text-2xl font-brand font-black uppercase italic mb-2 leading-none">{{selectedItem.title}}</h2>
                            <div class="text-2xl font-brand text-[#00ffaa] mb-8">{{selectedItem.price}} ‚ÇΩ</div>
                            <p class="text-gray-400 text-sm mb-10 whitespace-pre-wrap">{{selectedItem.desc_text}}</p>
                            <button @click="contactSeller" class="btn-prime w-full py-6 text-xs uppercase font-black">–°–≤—è–∑–∞—Ç—å—Å—è –≤ –¢–ì</button>
                        </div>
                    </div>
                </div>

            </transition>
        </main>

        <!-- üïπÔ∏è –¢–ê–ö–¢–ò–õ–¨–ù–´–ô –¢–ê–ë-–ë–ê–† -->
        <nav class="fixed bottom-8 inset-x-8 z-[100] max-w-sm mx-auto">
            <div class="glass rounded-[2.5rem] p-3 flex justify-around items-center shadow-2xl backdrop-blur-3xl border-white/10">
                <button @click="view = 'home'" :class="['tab-bar-item p-3', {active: view === 'home'}]">
                    <span class="text-xl">üè†</span>
                </button>
                <button @click="user ? view = 'add' : view = 'auth'" :class="['tab-bar-item p-3 btn-add-wrapper', {active: view === 'add'}]">
                    <div class="bg-[#00ffaa] text-black w-10 h-10 rounded-2xl flex items-center justify-center plus-icon shadow-lg">
                        <span class="text-xl font-bold">+</span>
                    </div>
                </button>
                <button @click="user ? (view = 'profile' || view === 'admin') : view = 'auth'" :class="['tab-bar-item p-3', {active: view === 'profile' || view === 'admin'}]">
                    <span class="text-xl">üë§</span>
                </button>
            </div>
        </nav>
    </div>
</div>

<script>
const { createApp } = Vue;

const SUPABASE_URL = 'https://gcxnstwsqkmdotqblkfd.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeG5zdHdzcWttZG90cWJsa2ZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4MDI3MzIsImV4cCI6MjA4MjM3ODczMn0.79gdNrKNRcdPTbban-6uK3GP5Czyq-II7kRHaRyfvqE';
const BOT_TOKEN = '7688454041:AAFFBc0Ye7RRq0RFuSst_QfTqQ0TpQu9aWI';
const MASTER_ADMIN_ID = 1735153058;

const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

createApp({
    data() {
        return {
            ageVerified: localStorage.getItem('bazar_age_final') === 'true',
            loading: true, view: 'home', profileTab: 'my',
            user: JSON.parse(localStorage.getItem('bazar_user_final')) || null,
            items: [], dbUsers: [], userMap: {},
            settings: { announcement: '' },
            categories: ['–í—Å–µ', '–ü–æ–¥—ã', '–ú–æ–¥—ã', '–ñ–∏–¥–∫–æ—Å—Ç–∏', '–ó–∞–ø—á–∞—Å—Ç–∏', '–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏'],
            filters: { cat: '–í—Å–µ' }, searchQuery: '',
            auth: { name: '' }, verifyCode: '',
            newItem: { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '', img2: '', img3: '' },
            editUser: { name: '', bio: '' },
            publishing: false, selectedItem: null, activeImg: null, strikeNoticeClosed: false, MASTER_ADMIN_ID: MASTER_ADMIN_ID
        }
    },
    computed: {
        isAdmin() { return this.user && (this.user.tg_id == MASTER_ADMIN_ID || this.user.rank >= 1); },
        marketVolume() { return this.items.reduce((sum, i) => sum + (i.price || 0), 0); },
        hotItems() { return this.items.filter(i => i.status !== 'sold').slice(0, 5); },
        sortedItems() {
            const q = this.searchQuery.toLowerCase().trim();
            return this.items.filter(i => {
                const matchCat = this.filters.cat === '–í—Å–µ' || i.category === this.filters.cat;
                const matchSearch = !q || i.title.toLowerCase().includes(q) || i.city.toLowerCase().includes(q);
                return matchCat && matchSearch;
            }).sort((a,b) => b.id - a.id);
        },
        myItems() { return this.user ? this.items.filter(i => i.user_id === this.user.id) : []; },
        favoriteItems() {
            const favIds = this.user ? (this.user.favorites || []) : [];
            return this.items.filter(i => favIds.includes(i.id));
        }
    },
    async mounted() {
        if (this.ageVerified) await this.init();
        else this.loading = false;
        
        client.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, () => this.fetchData()).subscribe();
        client.channel('any_users').on('postgres_changes', { event: '*', schema: 'public', table: 'users' }, () => this.fetchData()).subscribe();
    },
    methods: {
        async init() {
            this.loading = true;
            await this.fetchData();
            await this.fetchSettings();
            this.loading = false;
        },
        async fetchData() {
            try {
                const { data: it } = await client.from('items').select('*').order('id', {ascending: false});
                const { data: us } = await client.from('users').select('*');
                this.items = it || [];
                this.dbUsers = us || [];
                const map = {};
                this.dbUsers.forEach(u => map[u.id] = u);
                this.userMap = map;
                if (this.user) {
                    const fresh = this.dbUsers.find(u => u.id === this.user.id);
                    if (fresh) { 
                        this.user = fresh; 
                        this.editUser.name = fresh.name;
                        this.editUser.bio = fresh.bio || '';
                        localStorage.setItem('bazar_user_final', JSON.stringify(this.user)); 
                    }
                }
            } catch (e) { console.error(e) }
        },
        async fetchSettings() {
            const { data } = await client.from('settings').select('*').eq('id', 1).single();
            if (data) this.settings = data;
        },
        getRankName(u) {
            if (u.tg_id == MASTER_ADMIN_ID) return '–°–æ–∑–¥–∞—Ç–µ–ª—å';
            if (u.rank === 1) return '–ê–¥–º–∏–Ω';
            if (u.rank === 2) return '–°—Ç–∞—Ä—à–∏–π –∞–¥–º–∏–Ω';
            return '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        },
        getUserRankClass(u) {
            if (u.tg_id == MASTER_ADMIN_ID) return 'rank-creator';
            return 'rank-' + (u.rank || 0);
        },
        refreshSite() { window.location.reload(); },
        verifyAge() { this.ageVerified = true; localStorage.setItem('bazar_age_final', 'true'); this.init(); },
        
        // --- FIXED AUTH FOR MOBILE ---
        async startAuth() {
            if (!this.auth.name) return;
            this.verifyCode = Math.floor(1000 + Math.random() * 9000).toString();
            
            // 1. –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–¥–µ–ª–∞–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏)
            let startTime = Date.now();

            const poll = setInterval(async () => {
                if (this.view !== 'auth') return clearInterval(poll);
                try {
                    // 2. –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    const res = await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/getUpdates?offset=-10&limit=10`);
                    const data = await res.json();
                    
                    if(data.result && data.result.length > 0) {
                        // –ò—â–µ–º –∫–æ–¥ —Ç–æ–ª—å–∫–æ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö, –ø—Ä–∏—à–µ–¥—à–∏—Ö –ü–û–°–õ–ï —Å—Ç–∞—Ä—Ç–∞
                        const msg = data.result.find(u => u.message && u.message.text === this.verifyCode);
                        if (msg) { 
                            clearInterval(poll); 
                            await this.finalizeAuth(msg.message.from); 
                        }
                    }
                } catch (e) { console.error("Auth error", e) }
            }, 2000);
        },
        async finalizeAuth(tg) {
            // 1. –ò—â–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º —é–∑–µ—Ä–∞ –≤ –±–∞–∑–µ
            let { data: existingUser } = await client.from('users').select('*').eq('tg_id', tg.id).single();
            
            if (!existingUser) {
                const { data: newUser, error } = await client.from('users').insert([{ 
                    tg_id: tg.id, name: this.auth.name, rank: tg.id == MASTER_ADMIN_ID ? 3 : 0, is_admin: tg.id == MASTER_ADMIN_ID 
                }]).select().single();
                existingUser = newUser;
            }

            // 2. –ñ–ï–°–¢–ö–û–ï –°–û–•–†–ê–ù–ï–ù–ò–ï
            if(existingUser) {
                this.user = existingUser;
                localStorage.setItem('bazar_user_final', JSON.stringify(existingUser));
                
                // –î–∞–µ–º –±–∞–∑–µ –≤—Ä–µ–º—è
                setTimeout(() => {
                    window.location.reload(); // –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–´–ô –†–ï–õ–û–ê–î –î–õ–Ø –¢–ï–õ–ï–§–û–ù–ê
                }, 500);
            }
        },
        
        async toggleFavorite(id) {
            if (!this.user) return this.view = 'auth';
            let favs = [...(this.user.favorites || [])];
            if (favs.includes(id)) favs = favs.filter(f => f !== id);
            else favs.push(id);
            await client.from('users').update({ favorites: favs }).eq('id', this.user.id);
            this.user.favorites = favs; await this.fetchData();
        },
        isFavorite(id) { return this.user && this.user.favorites && this.user.favorites.includes(id); },
        async deleteItem(id) { if(confirm('–£–¥–∞–ª–∏—Ç—å?')) { await client.from('items').delete().eq('id', id); await this.fetchData(); } },
        openItem(item) { this.selectedItem = item; this.activeImg = item.img; this.view = 'product'; window.scrollTo(0,0); },
        contactSeller() { window.open(`https://t.me/${this.selectedItem.tg_user.replace('@', '')}`, '_blank'); },
        logout() { this.user = null; localStorage.removeItem('bazar_user_final'); this.view = 'home'; },
        triggerFile(n) { this.$refs['file'+n][0].click() },
        getNewImg(n) { return n === 1 ? this.newItem.img : n === 2 ? this.newItem.img2 : this.newItem.img3; },
        handleFileUpload(e, n) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (f) => {
                const img = new Image(); img.src = f.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const scale = 800 / img.width;
                    canvas.width = 800; canvas.height = img.height * scale;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 800, canvas.height);
                    const b64 = canvas.toDataURL('image/jpeg', 0.7);
                    if(n === 1) this.newItem.img = b64;
                    if(n === 2) this.newItem.img2 = b64;
                    if(n === 3) this.newItem.img3 = b64;
                }
            };
            reader.readAsDataURL(file);
        },
        async createListing() {
            this.publishing = true;
            await client.from('items').insert([{ ...this.newItem, user_id: this.user.id, seller_name: this.user.name }]);
            this.publishing = false; this.view = 'home'; await this.fetchData();
            this.newItem = { title: '', category: '–ü–æ–¥—ã', price: null, city: '', desc_text: '', tg_user: '', img: '', img2: '', img3: '' };
        },
        async saveProfile() {
            await client.from('users').update({ name: this.editUser.name, bio: this.editUser.bio }).eq('id', this.user.id);
            alert("‚ú® –ì–æ—Ç–æ–≤–æ!");
            await this.fetchData();
        },
        async handleAvatarUpload(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = async (f) => {
                const img = new Image(); img.src = f.target.result;
                img.onload = async () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 300; canvas.height = 300;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 300, 300);
                    const b64 = canvas.toDataURL('image/jpeg', 0.8);
                    await client.from('users').update({ avatar: b64 }).eq('id', this.user.id);
                    await this.fetchData();
                }
            };
            reader.readAsDataURL(file);
        }
    }
}).mount('#app')
</script>

</body>
</html>
